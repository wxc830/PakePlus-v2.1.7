<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英语单词学习应用 v3.1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- OpenRouter SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@openrouter/sdk@latest/dist/index.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#1F2937',
                        light: '#F9FAFB'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'custom': '0 10px 25px -5px rgba(0, 0, 0, 0.05)',
                        'custom-hover': '0 20px 35px -10px rgba(0, 0, 0, 0.1)',
                    }
                },
            }
        }
    </script>

    <!-- 初始化OpenRouter客户端 -->
    <script>
        // 初始化OpenRouter客户端（替换为你的API密钥）
        document.addEventListener('DOMContentLoaded', function() {
            // 检查OpenRouter SDK是否加载
            if (typeof OpenRouter !== 'undefined') {
                console.log('OpenRouter SDK加载成功');
            } else {
                console.log('OpenRouter SDK未加载，使用本地模拟模式');
            }

            // 2. 示例：绑定AI智能分析按钮的点击事件（对应仪表盘的AI分析功能）
            const aiAnalysisBtn = document.getElementById('aiAnalysisBtn');
            if (aiAnalysisBtn) {
                aiAnalysisBtn.addEventListener('click', async function() {
                    try {
                        // 禁用按钮防止重复点击
                        this.disabled = true;
                        this.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>分析中...';

                        // 示例：获取学习记录（你需要根据实际业务逻辑调整）
                        const learningData = getLearningHistoryData(); // 需自行实现该函数，获取要分析的学习数据
                        
                        // 调用OpenRouter API进行AI分析
                        // 注意：这部分代码已被移除，AI分析功能已集成到主应用逻辑中
                        console.log('AI分析功能已集成到主应用逻辑中');
                        return;

                    } catch (error) {
                        console.error("AI分析出错：", error);
                        alert("分析失败，请重试！");
                    } finally {
                        // 恢复按钮状态
                        this.disabled = false;
                        this.innerHTML = '<i class="fa fa-bar-chart mr-2"></i><span>AI智能分析</span><span id="usageCount" class="ml-2 text-xs bg-white text-secondary px-2 py-1 rounded-full">1</span>';
                    }
                });
            }

            // 辅助函数：获取学习记录数据（需根据你的业务逻辑实现）
            function getLearningHistoryData() {
                // 示例：从页面/本地存储中获取学习记录
                const historyTable = document.getElementById('historyTable');
                const records = [];
                // 遍历表格行获取数据（需适配你的实际DOM结构）
                historyTable.querySelectorAll('tr').forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length === 4) {
                        records.push({
                            word: cells[0].textContent,
                            chinese: cells[1].textContent,
                            result: cells[2].textContent,
                            date: cells[3].textContent
                        });
                    }
                });
                return records;
            }
        });
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .bg-gradient-blue {
                background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            }
            .bg-gradient-green {
                background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            }
            .bg-gradient-orange {
                background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
            }
            .btn-hover {
                transition: all 0.2s ease;
            }
            .btn-hover:hover {
                transform: scale(1.03);
            }
            .progress-bar {
                transition: width 0.5s ease;
            }
            .underline-link {
                text-decoration: underline;
                color: #6B7280;
                cursor: pointer;
            }
            .underline-link:hover {
                color: #3B82F6;
            }
        }
    </style>
    
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="custom.css">
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- 更新说明模态框 -->
    <div id="updateModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 p-6 transform transition-all">
            <div class="text-center mb-4">
                <div class="inline-block bg-primary p-4 rounded-full mb-2">
                    <i class="fa fa-info-circle text-3xl text-white"></i>
                </div>
                <h3 class="text-xl font-bold text-dark">版本更新说明 v3.1.0</h3>
            </div>
            <div class="text-gray-600 mb-6 max-h-96 overflow-y-auto pr-2">
                <ul class="list-disc pl-5 space-y-2">
                    <li>重磅更新：增加AI智能分析系统</li>
                    <li>整体页面焕然一新</li>
                    <li>实现数据加密存储，提高安全性</li>
                    <li>单词导入新增支持Excel格式</li>
                    <li>单词管理新增修改功能</li>
                    <li>学习时对空格和点号的容错处理优化</li>
                    <li>支持单词多种正确拼写方式</li>
                    <li>新增错误评判反馈功能</li>
                    <li>错误提示更详细，显示具体错误位置</li>
                    <li>修复仪表盘中学习进度和单词掌握模块显示问题</li>
                    <li>增加错题本导出功能</li>
                    <li>单词导出支持选择txt或Excel格式</li>
                    <li>完成一轮单词复习后可选择继续复习仍错误的单词</li>
                    <li>学习页面新增重新开始按钮</li>
                    <li>其他细节优化和bug修复</li>
                </ul>
            </div>
            <div class="flex justify-center">
                <button id="closeUpdateModal" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-full btn-hover">
                    我知道了
                </button>
            </div>
        </div>
    </div>

    <!-- 反馈模态框 -->
    <div id="feedbackModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6 transform transition-all">
            <div class="text-center mb-4">
                <h3 class="text-xl font-bold text-dark">反馈错误评判</h3>
            </div>
            <div class="text-gray-600 mb-4">
                <p class="mb-3">请选择错误原因：</p>
                <div class="space-y-2">
                    <div class="flex items-center">
                        <input type="radio" id="reason1" name="feedbackReason" value="评判错误" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" checked>
                        <label for="reason1" class="ml-2 block text-sm text-gray-700">评判错误</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="reason2" name="feedbackReason" value="手误" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                        <label for="reason2" class="ml-2 block text-sm text-gray-700">手误</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="reason3" name="feedbackReason" value="其他" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                        <label for="reason3" class="ml-2 block text-sm text-gray-700">其他</label>
                    </div>
                    <div id="otherReasonContainer" class="mt-2 hidden">
                        <label for="otherReason" class="block text-sm font-medium text-gray-700 mb-1">请说明：</label>
                        <textarea id="otherReason" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-primary" rows="2"></textarea>
                    </div>
                </div>
            </div>
            <div class="flex justify-center space-x-4">
                <button id="cancelFeedback" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-6 rounded-full btn-hover">
                    取消
                </button>
                <button id="submitFeedback" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-full btn-hover">
                    提交反馈
                </button>
            </div>
        </div>
    </div>

    <!-- 会员支付模态框 -->
    <div id="membershipModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6 transform transition-all relative">
            <div class="text-center mb-4">
                <div class="inline-block bg-accent p-4 rounded-full mb-2">
                    <i class="fa fa-star text-3xl text-white"></i>
                </div>
                <h3 class="text-xl font-bold text-dark">试用已结束</h3>
            </div>
            <div class="text-gray-600 mb-6">
                <p class="mb-3">您已使用本应用30分钟，如需继续使用，请开通会员。</p>
                <p class="mb-2"><strong>订单编号：</strong><span id="orderNumber"></span></p>
                <p class="mb-4">请添加微信 <strong>wxid_do5lg6q0fwp312</strong> 进行开通</p>
                <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                    <p class="text-sm text-yellow-800"><i class="fa fa-info-circle mr-1"></i> 开通会员后可享受全部功能，无使用时间限制</p>
                </div>
            </div>
            <div class="flex justify-center mb-4">
                <button id="buyMembershipDirect" class="bg-gradient-to-r from-accent to-yellow-500 hover:from-yellow-500 hover:to-accent text-white font-bold py-3 px-8 rounded-full shadow-lg btn-hover transform transition-all">
                    <i class="fa fa-shopping-cart mr-2"></i>购买会员
                </button>
            </div>
            <div class="flex justify-center mb-4">
                <button id="alreadyPurchased" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-2 px-6 rounded-full btn-hover">
                    我已购买
                </button>
            </div>
            <div id="membershipTypeContainer" class="hidden mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-3">请选择会员类型：</label>
                <div class="flex justify-center space-x-3">
                    <button class="membership-type-btn bg-primary hover:bg-primary/90 text-white font-bold py-2 px-4 rounded-lg btn-hover active" data-type="monthly">
                        月会员
                    </button>
                    <button class="membership-type-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg btn-hover" data-type="quarterly">
                        季会员
                    </button>
                    <button class="membership-type-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg btn-hover" data-type="annual">
                        年会员
                    </button>
                </div>
            </div>
            <div id="modalRedeemCodeContainer" class="hidden">
                <label for="modalRedeemCode" class="block text-sm font-medium text-gray-700 mb-1">请输入兑换码：</label>
                <input type="text" id="modalRedeemCode" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-primary mb-3">
                <div class="flex justify-center">
                    <button id="modalVerifyCode" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-full btn-hover">
                        验证兑换码
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-md fixed w-full z-40 transition-all duration-300" id="navbar">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-book text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-dark">单词学习助手</h1>
            </div>
            <nav class="hidden md:flex items-center space-x-6">
                <a href="#dashboard" class="text-gray-600 hover:text-primary transition-colors">仪表盘</a>
                <a href="#learn" class="text-gray-600 hover:text-primary transition-colors">开始学习</a>
                <a href="#review" class="text-gray-600 hover:text-primary transition-colors">错题复习</a>
                <a href="#settings" class="text-gray-600 hover:text-primary transition-colors">设置</a>
                <!-- 下载中心 -->
                <a href="https://dancibao.dpdns.org" target="_blank" rel="noopener noreferrer" class="text-gray-600 hover:text-primary transition-colors">下载中心</a>
                <!-- 会员中心 -->
                <div class="relative">
                    <button id="membershipCenterBtn" class="text-gray-600 hover:text-primary transition-colors focus:outline-none flex items-center space-x-1">
                        <span>会员中心</span>
                        <i class="fa fa-caret-down text-xs"></i>
                    </button>
                    <!-- 下拉菜单 -->
                    <div id="membershipDropdown" class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg z-50 hidden">
                        <a href="#redeemCode" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors" id="redeemCodeLink">
                            <i class="fa fa-qrcode mr-2"></i>核销兑换码（购买或续费）
                        </a>
                        <a href="https://dancibaovip.netlify.app/" target="_blank" rel="noopener noreferrer" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors" id="buyMembershipLink">
                            <i class="fa fa-shopping-cart mr-2"></i>购买会员
                        </a>
                    </div>
                </div>
            </nav>
            <button class="md:hidden text-gray-600" id="menuToggle">
                <i class="fa fa-bars text-xl"></i>
            </button>
        </div>
        <!-- 移动端菜单 -->
        <div class="md:hidden hidden bg-white w-full border-t" id="mobileMenu">
            <div class="container mx-auto px-4 py-2 flex flex-col space-y-3">
                <a href="#dashboard" class="text-gray-600 hover:text-primary py-2 transition-colors">仪表盘</a>
                <a href="#learn" class="text-gray-600 hover:text-primary py-2 transition-colors">开始学习</a>
                <a href="#review" class="text-gray-600 hover:text-primary py-2 transition-colors">错题复习</a>
                <a href="#settings" class="text-gray-600 hover:text-primary py-2 transition-colors">设置</a>
                <!-- 会员中心相关选项 -->
                <div class="border-t border-gray-100 pt-2 mt-2">
                    <div class="text-gray-500 text-sm font-medium mb-2 px-1">会员中心</div>
                    <a href="#redeemCode" class="text-gray-600 hover:text-primary py-2 transition-colors flex items-center space-x-2">
                        <i class="fa fa-qrcode"></i>
                        <span>核销兑换码（购买或续费）</span>
                    </a>
                    <a href="https://dancibaovip.netlify.app/" target="_blank" rel="noopener noreferrer" class="text-gray-600 hover:text-primary py-2 transition-colors flex items-center space-x-2">
                        <i class="fa fa-shopping-cart"></i>
                        <span>购买会员</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow pt-16">
        <!-- 欢迎页面 -->
        <section id="welcome" class="container mx-auto px-4 py-12 text-center">
            <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-custom p-8 card-hover">
                <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-dark mb-4">欢迎使用单词学习助手</h2>
                <p class="text-gray-600 mb-8 text-lg">提高你的英语词汇量，轻松掌握新单词！</p>
                <div class="flex flex-col sm:flex-row justify-center gap-4 mb-8">
                    <div class="bg-gradient-blue text-white p-4 rounded-xl w-full sm:w-64">
                        <i class="fa fa-graduation-cap text-3xl mb-2"></i>
                        <h3 class="font-bold text-lg">学习单词</h3>
                        <p class="text-sm opacity-90">通过互动练习记忆单词</p>
                    </div>
                    <div class="bg-gradient-green text-white p-4 rounded-xl w-full sm:w-64">
                        <i class="fa fa-line-chart text-3xl mb-2"></i>
                        <h3 class="font-bold text-lg">跟踪进度</h3>
                        <p class="text-sm opacity-90">查看你的学习统计数据</p>
                    </div>
                    <div class="bg-gradient-orange text-white p-4 rounded-xl w-full sm:w-64">
                        <i class="fa fa-refresh text-3xl mb-2"></i>
                        <h3 class="font-bold text-lg">复习错题</h3>
                        <p class="text-sm opacity-90">强化记忆薄弱单词</p>
                    </div>
                </div>
                <button id="startBtn" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-full shadow-lg btn-hover">
                    开始学习 <i class="fa fa-arrow-right ml-2"></i>
                </button>
            </div>
        </section>

        <!-- 核销兑换码页面 -->
        <section id="redeemCode" class="container mx-auto px-4 py-12 hidden">
            <h2 class="text-2xl font-bold text-dark mb-8 text-center">核销兑换码</h2>
            
            <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-custom p-8 card-hover mb-8">
                <!-- 会员详情信息 -->
                <div class="mb-8 bg-blue-50 p-6 rounded-xl">
                    <h3 class="text-xl font-bold text-dark mb-4">会员详情</h3>
                    
                    <!-- 会员权益 -->
                    <div class="mb-4">
                        <h4 class="font-bold text-gray-700 mb-2">会员权益</h4>
                        <ul class="list-disc pl-5 space-y-1 text-gray-600">
                            <li>无限制使用所有功能</li>
                            <li>单词学习无时间限制</li>
                            <li>优先体验新功能</li>
                            <li>专属客服支持</li>
                            <li>导出数据无限制</li>
                            <li>无广告干扰</li>
                        </ul>
                    </div>
                    
                    <!-- 有效期说明 -->
                    <div class="mb-4">
                        <h4 class="font-bold text-gray-700 mb-2">有效期说明</h4>
                        <ul class="list-disc pl-5 space-y-1 text-gray-600">
                            <li>月会员：有效期30天</li>
                            <li>季会员：有效期90天</li>
                            <li>年会员：有效期365天</li>
                            <li>会员有效期从激活之日起计算</li>
                            <li>续费后有效期叠加</li>
                        </ul>
                    </div>
                    
                    <!-- 相关条款 -->
                    <div>
                        <h4 class="font-bold text-gray-700 mb-2">相关条款</h4>
                        <ul class="list-disc pl-5 space-y-1 text-gray-600">
                            <li>兑换码仅可使用一次，不可重复使用</li>
                            <li>兑换码有效期以购买时为准</li>
                            <li>会员到期后将恢复为试用版本</li>
                            <li>请妥善保管您的兑换码，遗失不补</li>
                        </ul>
                    </div>
                </div>
                
                <!-- 会员类型选择 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">请选择会员类型：</label>
                    <div class="flex justify-center space-x-3">
                        <button class="membership-type-btn bg-primary hover:bg-primary/90 text-white font-bold py-2 px-4 rounded-lg btn-hover active" data-type="monthly">
                            月会员
                        </button>
                        <button class="membership-type-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg btn-hover" data-type="quarterly">
                            季会员
                        </button>
                        <button class="membership-type-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg btn-hover" data-type="annual">
                            年会员
                        </button>
                    </div>
                </div>
                
                <!-- 兑换码输入 -->
                <div>
                    <label for="redeemCodeInput" class="block text-sm font-medium text-gray-700 mb-1">请输入兑换码：</label>
                    <input type="text" id="redeemCodeInput" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-primary mb-4">
                    <div class="flex justify-center">
                        <button id="verifyCode" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-full shadow-lg btn-hover">
                            验证兑换码
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 仪表盘 -->
        <section id="dashboard" class="container mx-auto px-4 py-12 hidden">
            <h2 class="text-2xl font-bold text-dark mb-8 text-center">学习仪表盘</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-custom p-6 card-hover">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-gray-500">已学习单词</p>
                            <h3 class="text-3xl font-bold text-dark" id="learnedCount">0</h3>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fa fa-check-circle text-primary text-xl"></i>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-primary h-2 rounded-full progress-bar" id="learnedProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-custom p-6 card-hover">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-gray-500">正确率</p>
                            <h3 class="text-3xl font-bold text-dark" id="correctRate">0%</h3>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fa fa-percent text-secondary text-xl"></i>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-secondary h-2 rounded-full progress-bar" id="correctProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-custom p-6 card-hover">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-gray-500">今日学习</p>
                            <h3 class="text-3xl font-bold text-dark" id="todayCount">0</h3>
                        </div>
                        <div class="bg-orange-100 p-3 rounded-full">
                            <i class="fa fa-calendar-check-o text-accent text-xl"></i>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-accent h-2 rounded-full progress-bar" id="todayProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-custom p-6 card-hover">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-gray-500">错题数量</p>
                            <h3 class="text-3xl font-bold text-dark" id="wrongCount">0</h3>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full">
                            <i class="fa fa-times-circle text-danger text-xl"></i>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-danger h-2 rounded-full progress-bar" id="wrongProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white rounded-xl shadow-custom p-6 card-hover">
                    <h3 class="text-xl font-bold text-dark mb-4">学习进度</h3>
                    <div class="h-80">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-custom p-6 card-hover">
                    <h3 class="text-xl font-bold text-dark mb-4">单词掌握情况</h3>
                    <div class="h-80">
                        <canvas id="masteryChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="mt-8 bg-white rounded-xl shadow-custom p-6 card-hover">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-dark">最近学习记录</h3>
                    <div class="flex space-x-2">
                        <button id="exportBtn" class="bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg btn-hover">
                            <i class="fa fa-download mr-2"></i>导出Excel
                        </button>
                        <button id="aiAnalysisBtn" class="bg-secondary hover:bg-secondary/90 text-white py-2 px-4 rounded-lg btn-hover flex items-center">
                            <i class="fa fa-bar-chart mr-2"></i>
                            <span>AI智能分析</span>
                            <span id="usageCount" class="ml-2 text-xs bg-white text-secondary px-2 py-1 rounded-full">1</span>
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">单词</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">中文</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">结果</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="historyTable">
                            <!-- 历史记录将通过JS动态添加 -->
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-gray-500">暂无学习记录</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 学习页面 -->
        <section id="learn" class="container mx-auto px-4 py-12 hidden">
            <div class="max-w-2xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-dark">单词学习</h2>
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <span class="text-gray-500">进度: </span>
                        <span class="font-bold text-primary" id="learnProgress">0/0</span>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-custom p-8 mb-6 card-hover">
                    <div id="wordCard">
                        <h3 class="text-4xl font-bold text-center text-gray-800 mb-6" id="currentWord">单词将在这里显示</h3>
                        <div class="mb-8">
                            <input type="text" id="answerInput" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-primary transition-colors text-lg" placeholder="请输入对应的英文单词">
                        </div>
                        <div class="flex justify-center space-x-4">
                            <button id="checkBtn" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-full shadow-lg btn-hover">
                                检查答案
                            </button>
                            <button id="restartLearnBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-6 rounded-full btn-hover">
                                重新开始
                            </button>
                        </div>
                    </div>

                    <div id="resultCard" class="hidden">
                        <div class="text-center mb-6">
                            <div id="correctResult" class="hidden">
                                <div class="inline-block bg-green-100 p-4 rounded-full mb-2">
                                    <i class="fa fa-check-circle text-4xl text-secondary"></i>
                                </div>
                                <h3 class="text-3xl font-bold text-secondary mb-2">对了，你真棒(•̤̀ᵕ•̤́๑)و✧</h3>
                                <p class="text-gray-600">正确答案: <span id="correctWord" class="font-bold"></span></p>
                            </div>
                            <div id="wrongResult" class="hidden">
                                <div class="inline-block bg-red-100 p-4 rounded-full mb-2">
                                    <i class="fa fa-times-circle text-4xl text-danger"></i>
                                </div>
                                <h3 class="text-3xl font-bold text-danger mb-2">答错了，菜就多练</h3>
                                <p class="text-gray-600 mb-2">正确答案: <span id="wrongWord" class="font-bold"></span></p>
                                <p class="text-gray-600 mb-3">错误原因: <span id="errorReason" class="font-bold text-danger"></span></p>
                                <p class="underline-link" id="disagreeBtn">我不认同这个评判</p>
                            </div>
                        </div>
                        <div class="flex justify-center">
                            <button id="nextBtn" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-full shadow-lg btn-hover">
                                好的，继续 <i class="fa fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between">
                    <button id="backToDashboard" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-6 rounded-full btn-hover">
                        <i class="fa fa-arrow-left mr-2"></i>返回仪表盘
                    </button>
                    <button id="showHint" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-6 rounded-full btn-hover">
                        <i class="fa fa-lightbulb-o mr-2"></i>提示
                    </button>
                </div>
            </div>
        </section>

        <!-- 错题复习页面 -->
        <section id="review" class="container mx-auto px-4 py-12 hidden">
            <div class="max-w-2xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-dark">错题复习</h2>
                    <div class="flex items-center space-x-4">
                        <div class="bg-white p-3 rounded-lg shadow-sm">
                            <span class="text-gray-500">进度: </span>
                            <span class="font-bold text-primary" id="reviewProgress">0/0</span>
                        </div>
                        <button id="exportWrongWordsBtn" class="bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg btn-hover">
                            <i class="fa fa-download mr-2"></i>导出错题
                        </button>
                    </div>
                </div>

                <div id="reviewContent" class="bg-white rounded-2xl shadow-custom p-8 mb-6 card-hover">
                    <div id="reviewCard">
                        <h3 class="text-4xl font-bold text-center text-gray-800 mb-6" id="currentReviewWord">单词将在这里显示</h3>
                        <div class="mb-8">
                            <input type="text" id="reviewAnswerInput" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-primary transition-colors text-lg" placeholder="请输入对应的英文单词">
                        </div>
                        <div class="flex justify-center">
                            <button id="reviewCheckBtn" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-full shadow-lg btn-hover">
                                检查答案
                            </button>
                        </div>
                    </div>

                    <div id="reviewResultCard" class="hidden">
                        <div class="text-center mb-6">
                            <div id="reviewCorrectResult" class="hidden">
                                <div class="inline-block bg-green-100 p-4 rounded-full mb-2">
                                    <i class="fa fa-check-circle text-4xl text-secondary"></i>
                                </div>
                                <h3 class="text-3xl font-bold text-secondary mb-2">对了，你真棒(•̤̀ᵕ•̤́๑)و✧</h3>
                                <p class="text-gray-600">正确答案: <span id="reviewCorrectWord" class="font-bold"></span></p>
                            </div>
                            <div id="reviewWrongResult" class="hidden">
                                <div class="inline-block bg-red-100 p-4 rounded-full mb-2">
                                    <i class="fa fa-times-circle text-4xl text-danger"></i>
                                </div>
                                <h3 class="text-3xl font-bold text-danger mb-2">答错了，再试一次</h3>
                                <p class="text-gray-600 mb-2">正确答案: <span id="reviewWrongWord" class="font-bold"></span></p>
                                <p class="text-gray-600 mb-3">错误原因: <span id="reviewErrorReason" class="font-bold text-danger"></span></p>
                                <p class="underline-link" id="reviewDisagreeBtn">我不认同这个评判</p>
                            </div>
                        </div>
                        <div class="flex justify-center">
                            <button id="reviewNextBtn" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-full shadow-lg btn-hover">
                                好的，继续 <i class="fa fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 复习完成提示 -->
                <div id="reviewComplete" class="bg-white rounded-2xl shadow-custom p-8 mb-6 card-hover hidden text-center">
                    <div class="inline-block bg-green-100 p-4 rounded-full mb-4">
                        <i class="fa fa-trophy text-4xl text-secondary"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-dark mb-2">复习完成！</h3>
                    <p class="text-gray-600 mb-6" id="reviewCompleteMessage">你已经完成了所有错题的复习</p>
                    <div id="reviewAgainSection" class="hidden mb-6">
                        <p class="text-gray-600 mb-4">还有一些单词仍然错误，是否继续复习？</p>
                        <div class="flex justify-center space-x-4">
                            <button id="reviewAgainBtn" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-full btn-hover">
                                继续复习
                            </button>
                            <button id="finishReviewBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-6 rounded-full btn-hover">
                                结束复习
                            </button>
                        </div>
                    </div>
                    <button id="backAfterReviewBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-6 rounded-full btn-hover">
                        返回仪表盘
                    </button>
                </div>

                <div class="flex justify-between">
                    <button id="backFromReview" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-6 rounded-full btn-hover">
                        <i class="fa fa-arrow-left mr-2"></i>返回仪表盘
                    </button>
                    <button id="reviewHint" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-6 rounded-full btn-hover">
                        <i class="fa fa-lightbulb-o mr-2"></i>提示
                    </button>
                </div>

                <div class="mt-8 bg-white rounded-xl shadow-custom p-6 card-hover">
                    <h3 class="text-xl font-bold text-dark mb-4">我的错题本</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="wrongWordsList">
                        <!-- 错题将通过JS动态添加 -->
                        <div class="col-span-full text-center text-gray-500">暂无错题</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 修改单词模态框 -->
        <div id="editWordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6 transform transition-all">
                <div class="text-center mb-4">
                    <h3 class="text-xl font-bold text-dark">修改单词</h3>
                </div>
                <div class="text-gray-600 mb-6">
                    <input type="hidden" id="editWordIndex">
                    <div class="mb-4">
                        <label for="editEnglish" class="block text-sm font-medium text-gray-700 mb-1">英文单词 (多个拼写用逗号分隔)</label>
                        <input type="text" id="editEnglish" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-primary">
                    </div>
                    <div>
                        <label for="editChinese" class="block text-sm font-medium text-gray-700 mb-1">中文翻译</label>
                        <input type="text" id="editChinese" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-primary">
                    </div>
                </div>
                <div class="flex justify-center space-x-4">
                    <button id="cancelEditWord" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-6 rounded-full btn-hover">
                        取消
                    </button>
                    <button id="saveEditWord" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-full btn-hover">
                        保存
                    </button>
                </div>
            </div>
        </div>

        <!-- 设置页面 -->
        <section id="settings" class="container mx-auto px-4 py-12 hidden">
            <div class="max-w-3xl mx-auto">
                <h2 class="text-2xl font-bold text-dark mb-8 text-center">设置</h2>

                <div class="bg-white rounded-2xl shadow-custom p-8 mb-8 card-hover">
                    <h3 class="text-xl font-bold text-dark mb-6">单词管理</h3>

                    <div class="mb-6">
                        <h4 class="font-bold text-gray-700 mb-3">添加新单词</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="newWord" class="block text-sm font-medium text-gray-700 mb-1">英文单词 (多个拼写用逗号分隔)</label>
                                <input type="text" id="newWord" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-primary">
                            </div>
                            <div>
                                <label for="newTranslation" class="block text-sm font-medium text-gray-700 mb-1">中文翻译</label>
                                <input type="text" id="newTranslation" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-primary">
                            </div>
                        </div>
                        <div class="mt-4">
                            <button id="addWordBtn" class="bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg btn-hover">
                                <i class="fa fa-plus mr-2"></i>添加单词
                            </button>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="font-bold text-gray-700 mb-3">批量导入单词</h4>
                        <div class="flex items-center">
                            <label for="wordFile" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded-lg cursor-pointer transition-colors">
                                <i class="fa fa-upload mr-2"></i>选择文件
                            </label>
                            <input type="file" id="wordFile" accept=".txt,.csv,.xlsx,.xls" class="hidden">
                            <span id="fileName" class="ml-4 text-gray-500">未选择文件</span>
                        </div>
                        <p class="mt-2 text-sm text-gray-500">支持TXT、CSV、Excel格式，每行格式为：单词(多个用逗号分隔),翻译</p>
                        <div class="mt-4">
                            <button id="importWordsBtn" class="bg-secondary hover:bg-secondary/90 text-white py-2 px-4 rounded-lg btn-hover">
                                <i class="fa fa-download mr-2"></i>导入单词
                            </button>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-gray-700">我的单词库</h4>
                            <div class="flex space-x-2">
                                <button id="deleteAllWords" class="bg-danger hover:bg-danger/90 text-white py-1 px-3 rounded-lg text-sm btn-hover">
                                    <i class="fa fa-trash mr-1"></i>清空
                                </button>
                                <div class="relative inline-block">
                                    <button id="exportAllWords" class="bg-primary hover:bg-primary/90 text-white py-1 px-3 rounded-lg text-sm btn-hover">
                                        <i class="fa fa-download mr-1"></i>导出
                                    </button>
                                    <div id="exportFormatMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg z-10">
                                        <button id="exportAsTxt" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                            导出为TXT
                                        </button>
                                        <button id="exportAsExcel" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                            导出为Excel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">英文</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">中文</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="wordsTable">
                                    <!-- 单词列表将通过JS动态添加 -->
                                    <tr>
                                        <td colspan="3" class="px-6 py-4 text-center text-gray-500">暂无单词，请添加新单词</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-custom p-8 mb-8 card-hover">
                    <h3 class="text-xl font-bold text-dark mb-6">学习设置</h3>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">提示设置</label>
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <input id="showFirstLetter" type="checkbox" checked class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                                <label for="showFirstLetter" class="ml-2 block text-sm text-gray-700">显示首字母</label>
                            </div>
                            <div class="flex items-center">
                                <input id="showWordLength" type="checkbox" checked class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                                <label for="showWordLength" class="ml-2 block text-sm text-gray-700">显示单词长度</label>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <h4 class="font-bold text-gray-700 mb-3">数据管理</h4>
                        <div class="flex space-x-4">
                            <button id="resetProgress" class="bg-danger hover:bg-danger/90 text-white py-2 px-4 rounded-lg btn-hover">
                                <i class="fa fa-refresh mr-2"></i>重置学习进度
                            </button>
                            <button id="deleteAllData" class="bg-dark hover:bg-dark/90 text-white py-2 px-4 rounded-lg btn-hover">
                                <i class="fa fa-trash mr-2"></i>删除所有数据
                            </button>
                        </div>
                    </div>
                </div>

                <div class="text-center">
                    <button id="saveSettings" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-full shadow-lg btn-hover">
                        保存设置
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-8">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4">单词学习助手</h3>
                    <p class="text-gray-400">提高你的英语词汇量，轻松掌握新单词！</p>
                </div>
                <div>
                    <h4 class="font-bold mb-4">快速链接</h4>
                    <ul class="space-y-2">
                        <li><a href="#dashboard" class="text-gray-400 hover:text-white transition-colors">仪表盘</a></li>
                        <li><a href="#learn" class="text-gray-400 hover:text-white transition-colors">开始学习</a></li>
                        <li><a href="#review" class="text-gray-400 hover:text-white transition-colors">错题复习</a></li>
                        <li><a href="#settings" class="text-gray-400 hover:text-white transition-colors">设置</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-4">联系我们</h4>
                    <ul class="space-y-2">
                        <li class="flex items-center">
                            <i class="fa fa-envelope-o mr-2 text-gray-400"></i>
                            <a href="mailto:support@dancibao.cc.cd" class="text-gray-400 hover:text-white transition-colors">support@dancibao.cc.cd</a>
                        </li>
                        <li class="flex items-center">
                            <i class="fa fa-envelope-o mr-2 text-gray-400"></i>
                            <a href="mailto:service@dancibao.cc.cd" class="text-gray-400 hover:text-white transition-colors">service@dancibao.cc.cd</a>
                        </li>
                        <li class="flex items-center">
                            <i class="fa fa-weixin mr-2 text-gray-400"></i>
                            <span class="text-gray-400">wxid_do5lg6q0fwp312</span>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
                <p>&copy; 2025 单词学习助手 | 版权所有</p>
            </div>
        </div>
    </footer>

    <!-- 模态框 -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6 transform transition-all">
            <div class="text-center mb-4">
                <div id="modalIcon" class="inline-block bg-primary p-4 rounded-full mb-2">
                    <i class="fa fa-info-circle text-3xl text-white"></i>
                </div>
                <h3 id="modalTitle" class="text-xl font-bold text-dark">提示</h3>
            </div>
            <p id="modalMessage" class="text-gray-600 mb-6 text-center">这是一条模态框消息</p>
            <div class="flex justify-center">
                <button id="closeModal" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-full btn-hover">
                    确定
                </button>
            </div>
        </div>
    </div>

    <!-- 邀请码输入模态框 -->
    <div id="inviteCodeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6 transform transition-all">
            <div class="text-center mb-4">
                <div class="inline-block bg-secondary p-4 rounded-full mb-2">
                    <i class="fa fa-key text-3xl text-white"></i>
                </div>
                <h3 class="text-xl font-bold text-dark">邀请码验证</h3>
            </div>
            <div class="text-gray-600 mb-6">
                <p class="mb-3">您的每日使用次数已用完，请输入邀请码获取额外使用次数。</p>
                <label for="inviteCodeInput" class="block text-sm font-medium text-gray-700 mb-1">请输入邀请码：</label>
                <input type="text" id="inviteCodeInput" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-primary">
            </div>
            <div class="flex justify-center space-x-4">
                <button id="cancelInviteCode" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-6 rounded-full btn-hover">
                    取消
                </button>
                <button id="verifyInviteCode" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-2 px-6 rounded-full btn-hover">
                    验证邀请码
                </button>
            </div>
        </div>
    </div>

    <!-- AI分析结果模态框 -->
    <div id="aiAnalysisModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-3xl w-full mx-4 p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-dark">AI智能分析结果</h3>
                <button id="closeAiAnalysis" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="mb-6">
                <div id="aiAnalysisLoading" class="hidden text-center py-10">
                    <i class="fa fa-spinner fa-spin text-4xl text-primary mb-2"></i>
                    <p class="text-gray-600">AI正在分析您的学习数据，请稍候...（大约需要1分钟）</p>
                </div>
                <div id="aiAnalysisResult" class="max-h-96 overflow-y-auto pr-2">
                    <div class="prose max-w-none">
                        <!-- 分析结果将在这里显示 -->
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-4">
                <button id="saveAiAnalysis" class="bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg btn-hover">
                    <i class="fa fa-save mr-2"></i>保存结果
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let appStartTime = new Date();
        let membershipVerified = false;
        
        // 时间限制常量（30分钟）
        const USAGE_TIME_LIMIT = 30 * 60 * 1000;
        
        // 初始化应用开始时间（使用多重存储验证）
        function initAppStartTime() {
            const now = Date.now();
            const localStorageTime = localStorage.getItem('appStartTime');
            const sessionStorageTime = sessionStorage.getItem('appStartTime');
            const encryptedTime = localStorage.getItem('appStartTimeHash');
            
            // 如果有加密的时间戳，验证其完整性
            if (encryptedTime) {
                try {
                    // 简单的验证逻辑：解密后的时间戳应该接近存储的时间
                    const decrypted = atob(encryptedTime);
                    const [storedTime, checksum] = decrypted.split('_');
                    const expectedChecksum = String(parseInt(storedTime) + 12345);
                    
                    if (checksum === expectedChecksum && Math.abs(now - parseInt(storedTime)) < USAGE_TIME_LIMIT * 2) {
                        // 加密时间有效，使用最早的有效时间
                        if (localStorageTime && sessionStorageTime) {
                            appStartTime = new Date(Math.min(parseInt(localStorageTime), parseInt(sessionStorageTime), parseInt(storedTime)));
                        } else if (localStorageTime) {
                            appStartTime = new Date(Math.min(parseInt(localStorageTime), parseInt(storedTime)));
                        } else if (sessionStorageTime) {
                            appStartTime = new Date(Math.min(parseInt(sessionStorageTime), parseInt(storedTime)));
                        } else {
                            appStartTime = new Date(parseInt(storedTime));
                        }
                        return;
                    }
                } catch (e) {
                    console.log('时间戳验证失败，使用默认时间');
                }
            }
            
            // 使用最早的有效时间戳
            if (localStorageTime && sessionStorageTime) {
                appStartTime = new Date(Math.min(parseInt(localStorageTime), parseInt(sessionStorageTime)));
            } else if (localStorageTime) {
                appStartTime = new Date(parseInt(localStorageTime));
            } else if (sessionStorageTime) {
                appStartTime = new Date(parseInt(sessionStorageTime));
            } else {
                // 首次访问，保存时间戳
                appStartTime = new Date(now);
                saveStartTime();
            }
        }
        
        // 保存开始时间（使用多重存储和加密）
        function saveStartTime() {
            const timeValue = appStartTime.getTime();
            const checksum = String(timeValue + 12345);
            const encryptedTime = btoa(`${timeValue}_${checksum}`);
            
            localStorage.setItem('appStartTime', timeValue);
            sessionStorage.setItem('appStartTime', timeValue);
            localStorage.setItem('appStartTimeHash', encryptedTime);
        }
        
        // 检查时间是否超过限制
        function checkTimeLimit() {
            const now = Date.now();
            const elapsed = now - appStartTime.getTime();
            
            // 如果时间被重置（当前时间早于开始时间），使用最早的有效时间
            if (elapsed < 0) {
                const localStorageTime = localStorage.getItem('appStartTime');
                if (localStorageTime) {
                    appStartTime = new Date(parseInt(localStorageTime));
                    return now - appStartTime.getTime() > USAGE_TIME_LIMIT;
                }
            }
            
            return elapsed > USAGE_TIME_LIMIT;
        }
        
        // 验证时间完整性
        function verifyTimeIntegrity() {
            const now = Date.now();
            const localStorageTime = localStorage.getItem('appStartTime');
            const sessionStorageTime = sessionStorage.getItem('appStartTime');
            
            // 如果localStorage和sessionStorage中的时间不一致，检测到异常
            if (localStorageTime && sessionStorageTime) {
                const diff = Math.abs(parseInt(localStorageTime) - parseInt(sessionStorageTime));
                if (diff > USAGE_TIME_LIMIT) {
                    // 时间被篡改，使用最早的时间
                    appStartTime = new Date(Math.min(parseInt(localStorageTime), parseInt(sessionStorageTime)));
                    return false;
                }
            }
            
            return true;
        }
        
        // 定期检查时间完整性
        function startTimeIntegrityCheck() {
            // 每分钟检查一次时间完整性
            setInterval(() => {
                if (!membershipVerified) {
                    verifyTimeIntegrity();
                    if (checkTimeLimit()) {
                        checkUsageTime();
                    }
                }
            }, 60000);
        }
        
        // 监听页面可见性变化
        function initVisibilityListener() {
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible' && !membershipVerified) {
                    // 页面重新可见时，检查时间限制
                    if (checkTimeLimit()) {
                        checkUsageTime();
                    }
                }
            });
        }
        
        // 简单的加密函数，用于加密兑换码
        function encryptCode(code) {
            // 使用简单的字符替换和位置变换进行加密
            let encrypted = '';
            for (let i = 0; i < code.length; i++) {
                let charCode = code.charCodeAt(i);
                // 字符编码偏移
                charCode += 3;
                // 位置变换
                let newIndex = (i + 5) % code.length;
                encrypted = encrypted.padEnd(newIndex + 1, ' ');
                encrypted = encrypted.substring(0, newIndex) + String.fromCharCode(charCode);
            }
            return encrypted;
        }
        
        // 月会员兑换码（从兑换码.txt文件导入）
        const monthlyCodes = [
            "pis3xo-7Wj7mq-Slfv", "gm7WEz-FX3O2L-HuQa", "7iesJh-nByh2R-lv1j", "pY1ei2-SMEW2W-9THY", "VLDfbO-GChDAL-84pf", "fOvChg-UsDmmb-s7GS", "1616fR-XdKfrh-Nsgf", "QuZqHq-kWxnmY-SVLL", "8pKOh4-uyQvxt-TQJz", "GwXLU1-RZ5Py4-FdKj", "WStoji-jTLy69-Z3n4", "kwjyF4-AcQcZ8-QTsn", "Cot3kQ-ryr4Gf-OW0A", "oUnfGJ-1yX08n-7dd4", "jBO3VR-jJmkAx-FJ3T", "AGF2Dm-LYSybi-qBN1", "W60xKU-4MtlRN-yXBW", "2HFaQD-GzvZl2-LNY2", "PnZ1yj-lyIVGm-Bwem", "dWD7EP-VZzWfO-ZTF9", "70bZru-mF9qlY-99tc", "SCCJmg-lQ46dF-6JFQ", "S2gGhZ-i6rSK5-WGWs", "Jk1yjq-dBKHMi-J5I3", "fP56Sr-BHVs9E-ukNa", "nSfmpf-l6GTBR-IdnE", "nOgnGv-CFueej-r2am", "hfU9fl-MrVF2p-MTSX", "4osKW7-ABWnaN-l5MP", "nYTvlG-NGeAY1-nlGN", "iM2Qrh-ESSYwF-UnBS", "q4Wcbs-3maZD5-YBVY", "KraoXD-aw0ZVL-5KBk", "8yr7ul-QwKQ3n-Dul7", "ZKodsi-fmcHDK-OoXU", "4eidb0-PABu7y-ZEx9", "hdA894-lY6uOo-hEPr", "K5EHck-BTd54I-ZnOh", "t9ei3i-sPuh5r-OmtN", "xlctsX-rXtrsc-QB9z", "Hk4VJM-oiAC9k-2Mzr", "FUmQdL-t0xDa2-8Yid", "kcQKio-O10YM9-UA8H", "1Tza6u-oVc72z-4ad3", "e3pJTp-GPkliX-WfaH", "6QpBSD-EJOvSJ-eSeC", "oOVJs2-XQmB7s-U6WC", "2DTMHf-Z8SUe3-wxzR", "ojfl6P-Sl7BwR-cAK5", "hrDfsK-0Kh0Bt-Z14X", "FR9TOF-6vVEUI-D4JN", "g1fxBY-wMWHng-oQ9P", "8wa4DH-HgskWw-O1Oj", "wTRSi1-LekbAX-IeYG", "GRVoV8-Z3KkFM-tC7W", "poUNaq-R8l17Y-Xgho", "v51KQ9-XzJeTK-RNjW", "rcdCy9-bamviu-BzUh", "z3Epbc-irxp3e-0eiP", "nVroTK-KeBeI9-2BK5", "Yh3yYJ-dn59dH-u7cW", "csT6UX-XL9bch-x9l8", "o6dQXG-dJBvvZ-aRWW", "Um5nVg-lGOAor-2XUb", "nJtCSM-uBEv5T-lgRv", "gDGVwk-9tl5TL-mNqH", "0iZYsj-oqWrrW-k2bu", "iVq3u2-jUOdZq-ImIX", "QQZv2c-8y3T9V-Y20W", "WC4IRt-nJGEOy-TWb7", "cLJXMC-ScTrRz-1JoA", "WnYUiP-i0ssEc-Z15x", "ZeeYiF-CNabdS-zY9P", "IjFNih-gF3nP1-uXzd", "hCFc2e-7odJ3L-osBN", "b6pvj5-gYLCax-cv8P", "U3ahoI-dHQ9y3-cZh0", "8pVMCJ-kqjYiX-UsRm", "a0RmpE-pRdxZ8-jOHG", "nqAkrA-LfmWQQ-cVIg", "haNuU7-Jlepb2-4koW", "H0QsCV-cXwpGf-UeRS", "lvCY7F-pwGVcA-HuZg", "glnnCm-I1TSzk-vR2Z", "NxUh1C-aAndWM-GDms", "RWpGCU-wemhXo-MUWf", "oavg7G-HG37Is-UuFq", "7Ktcld-8emIyn-rFhK", "gNDTu3-b98pzQ-6fQD", "QjoOFA-F5Gm0s-O6a3", "HxsVv6-uEJfbA-AbgQ", "OHOd6e-BuDbW5-FuTq", "vB9UpD-Onmz7o-Li4j", "wCOnL2-iM1UKU-04e2", "rTkrlr-C1iTfu-AX1R", "ZqWE6B-FJuUUN-VADn", "lYK1k7-ql7xam-xHJV", "CNatLm-axZYG9-MwX2", "PcyTIi-nrKv6n-RtMz", "MOL8lk-jPskpN-LHjr", "y807Og-qEVQl8-UIIm", "pKhyE7-Nrlm65-XFTB", "6zUvpH-FUJjVG-s5vR", "nHkmj6-K5vPn5-F853", "KyIbb7-OeDns8-8kHd", "PMIGzW-OhMsOf-Vdle", "PekuxH-xEuVzL-4rnH", "CSv4yt-VvX8m8-Lvbd", "dYxLg8-1Ri0wU-53fw", "O4iow2-sNmQbj-siwM", "OjNKXv-YzjA7Q-B9SL", "cl3okG-X5TZrT-5kBh", "KDu2KI-sF6ijo-ZtQE", "ksu3Xt-jVXglS-zzdq", "2AhCo3-vbwsj7-nLeW", "gUlSNO-feFff9-qmsz", "pijpVs-RUp3pz-2HJW", "Xs5E0r-UZ83CI-cAns", "PpV50G-LAsSZ3-5ZPc", "jiP5vb-Fjgj7i-EqpE", "n34KxK-sH0Eud-p5Sp", "zrieWP-1mDARO-jmHn", "ZmVbq3-Iu1cEP-slmD", "1uvM1Y-gQPmVJ-WPys", "oG6x17-CfyJJJ-irMf", "z4l3ZW-NFgdhU-G7Rd", "rceDjm-noWxFx-W5jJ", "2h38VI-RjFPCj-j533", "fTuRyQ-WcEB85-tSID", "EGu9Cd-0w2Ec0-XBco", "INebZk-ENeV9W-nxnA", "HW0DQn-6Nzaih-KMie", "L9MXf6-lqiJuy-069U", "NpDJvb-PI6jUD-Za9d", "S2YYHx-EYx6Hg-S3QK", "ZICjmv-fWMipa-2TfD", "gqFyN5-XwpC3W-B1U8", "hVSCho-9waxjS-4PCF", "smRZ3I-f1rQbA-4rm3", "9u7jkc-0YQfcZ-XrDR", "N8TsG1-kB3CZe-YKJX", "bOSpfF-qFfroh-9evZ", "GR4Yaq-M3fEqw-gO5I", "aaxvE2-HRihsH-giO6", "frD7BJ-vWfNEK-Z4SW", "qjT7SW-r1lnQ4-oeN5", "ZRTxzv-kG9DF0-xUVL", "YGCVr9-MBdTsT-IAJY", "GoiVMZ-JsdXLx-hveI", "mnbxv0-EOGgCK-AEYn", "riurhN-wQVa2Y-q4UK", "NagDh9-5rP7qi-25ak", "2rWCCm-sQ6l1f-tlhD", "ja6uat-QWyeZ8-Gu7J", "YzYqLW-3JCWYA-Q9M8", "hHMYDO-Klc5Iy-9AFz", "TXkYPM-LT0ybo-ctvw", "8CBBr0-1ZQBsU-QxDt", "Hi4p5B-du8AOj-8PGY", "41qxpb-w7zby0-vp47", "PWS57x-OytcVK-DUbL", "x4Pdm5-bsd8cw-nHIb", "p3M4dF-YFSZbU-YlnZ", "MCEea4-9sVOu8-0ZWB", "oyjT6o-LgDXSG-jYQy", "23guHW-5o9L8f-p8rL", "JbmObs-RO6JEu-u0xM", "rbcMnL-N97HGf-Eg0u", "HnF8JN-20GWPD-0Z7w", "vkCTxW-EWwEwD-5gVz", "myqqJG-CCIiS1-Qv4o", "ZuILnk-qW6yc6-osEH", "wMjyhC-zjNPsp-HQGV", "gxX2xa-noGCQl-wpnD", "2rXEbo-1RFvGC-mAKw", "TfEDHO-zDhWke-CFec", "OxCWNs-NSJcst-jhq9", "x8JzLL-ciyW1S-gyhu", "JTyV67-RL6CML-12jS", "vEDuCy-x1AcP7-9OPR", "Oab1d8-g8hO2A-zoBS", "bvgdV8-SFGT9M-EOfh", "EHaL4u-UO8Brh-Wtrs", "P9usaa-kPVkwo-T4MX", "Mlbcxo-n2fS1j-uCzH", "14wVPj-ppl9Wk-HMeD", "sAhcsh-fdVAe2-ufKw", "D3z4kk-xjKoYm-NchK", "A8clam-IpU1Wi-9wU2", "VhCuvD-097I2P-K94E", "sXMynR-fMX7Ev-wRPs", "KLDGz2-JnDZNj-FFSP", "AuOAF3-Sp3SnT-9YVH", "PrNoj2-VN92Q6-X1oo", "ZeYzm0-EaXiUS-QSyz", "JexE7P-fvMt7V-ThnH", "1Rdkz1-3znQ88-FfQn", "D1wIz5-ag2pMF-msRy", "iUfhn9-Qoq9sc-aZUf"
        ];
        
        // 季度会员兑换码（从兑换码.txt文件导入）
        const quarterlyCodes = [
            "jLQHcu-D3GCWa-xsxL", "ufkecl-slOoPx-BylG", "reedhD-oPWchh-UiI1", "uszSOW-GeF4Cw-uVFQ", "iQguPX-owqhoA-KAEn", "aVG3ol-jccPv0-35g4", "EasfSw-gdOcEI-khjS", "SFaZKo-SIq9qa-uC2D", "Ys0WlK-2e5OIu-Hsfl", "ZpWdfP-USZV51-dNHO", "onwZpr-wHwepu-62a6", "g0ysqt-9C92lu-V5oK", "2ADgW0-8EpgtR-ah7J", "yeB88q-vbfj1I-48Ni", "WcYy1N-m7jM1p-n6Nv", "PLMgJy-kONZb5-hLIr", "z7mdDV-gbJJ8O-eVSa", "hzpCoF-Jbdwcm-omr7", "ERfO0n-HLgCdr-TJMK", "2bkQKe-j41vDD-ckt5", "yDsyVa-IQbngl-dXr2", "hGzBjd-o3gMX7-K1Vx", "LRc4Qz-acyuNG-Gnq5", "OTm235-VXiykG-HNyZ", "UzUJaU-aeJ5fB-8q1v", "AHGOPw-iTcfqt-LM1s", "7TjMJn-Gi7kxz-UAv0", "9hsLIn-3oCXqi-wKNC", "A4UZie-PuPUbD-GxnU", "6yOpBB-oHYEfT-cDA0", "iWljoD-SvpToN-BreJ", "oePZnx-DDAwXc-XsKb", "LjztOd-28mck7-ERrA", "83HGvh-KHIwnQ-E83X", "aBuItN-Hdq2Um-ePCb", "Y9X7xP-esPxUO-HsfY", "TMtoj6-hNV97G-2xdQ", "m2RoHA-wukCtr-Zp95", "GGShsC-57qGsN-58VX", "W6npdg-mKsfmz-iE4u", "CJpEYD-fTyzlX-41we", "Nwucyf-Kjiv19-lSdr", "Th1Wep-oi3Wn9-77rN", "tl3ppt-WNp9xh-slsS", "FYkBaf-Wly8Q3-PV1W", "ZvuWs4-dxoSZb-V2qL", "ioBbR8-dIKXuJ-56bh", "SphpbN-UhRMNp-FPhZ", "ksb425-NkWbgs-VQsF", "SP2Wnx-adl9Ia-6a89", "TCxQd9-rg9EvC-kc9x", "lolg1y-p0OrYH-Yvxb", "DQaWsi-8OBGAW-RLE4", "6A2sqw-NRWYIF-ct6G", "DaGxgz-4JrgcB-1rcq", "3wd14Y-bgljR0-V7o7", "laqmHn-N5gOQr-HFYG", "edmIjR-RAItyT-rZwv", "InAscf-p2t9xk-tJp7", "YiI8iy-ScrI6K-5yDi", "qxodo6-fhb7fQ-XwYv", "44GjVk-4IdWEz-qIQT", "1jXJRq-lAAksT-oHYN", "ilCZRW-pSBT5c-OpJk", "aLNBNu-4kGpe9-h7MN", "L7VaWN-9KzXXA-xO48", "o6Cxla-LQksxM-2I16", "MledWz-5LTt9y-0jAP", "nGebXt-FwRnLe-enbZ", "z2NE2W-3cc4jN-kWVD", "LTRTnF-ILGeIW-F8HZ", "MwGpEO-4jUIhZ-oI8Y", "i1PfOm-zxWV5t-j3Pn", "OIldSY-C7qe39-yi6I", "V3Isne-rpFFwJ-xhyo", "opbOeN-JUYJ85-UraE", "PTfUQu-mZXxpT-NWpM", "3GaqHH-o9tVlE-6v8k", "4DcFgE-502J4X-xY0r", "W8nXqM-yvZOoY-T72K", "i5DF2H-c4Fozu-XffD", "ykdJW0-oJipWZ-8AZK", "ceAuHS-pvqSnI-HYOG", "zbu8bR-ojfSmD-TpdF", "MozJpT-oT2S3C-1hbB", "iO6nn3-Vwc3ht-xFYd", "FBWmBF-NpBHsj-irCw", "sr6Kbs-UwDqFy-f3fj", "90flTs-DRWpjO-KHMP", "XskUAb-CRgHaH-3pcm", "r91QDf-0Yr7jq-WG7R", "IZRR5g-8uVfYi-gvZT", "h7qaeW-c2Cwy2-Ottb", "ZGJdTX-37woGj-5Nvi", "izhPRS-nF3D83-5BUX", "DOk8aN-9y8wcO-70W5", "fqDmCW-9bGLJZ-j3yx", "LEuiQU-SGpPpv-IvmV", "tzreyv-5MT5aJ-qT0q", "gWja1U-kaZyWr-NdDF", "keEkIn-VfEMZV-WALR", "oM18kp-0EZuXG-YjDN", "JGuJxd-63VHP7-imOr", "XTUYZ0-F9AZaI-tWsA", "YlomMs-k97G4S-4u9W", "q48b46-dTXEAX-sOXs", "9BcXyq-5Cdsjt-ysDm", "YspzKf-WfBodd-DPyv", "BIbdxq-9FyA48-1b6f", "SaBn2C-TbIi48-VlOs", "jFg4rE-2WiiQV-LAdz", "eovXrd-vTHOTm-YxQf", "190dli-wlzk9s-yItb", "DYdeOI-0NYpcX-Xh80", "HLFgM2-3GqWX0-Umnt", "zOkFOT-jb56WX-dKEk", "yPUWos-RtkmH7-Jrtc", "WRHkVE-wuS8cZ-jfni", "iNTXQW-Q4ojYB-3UEQ", "rF02Xe-PMOnO0-0EWq", "ffYu5x-AY3gbp-if4T", "m1tLKn-NsvVAM-NLgP", "Ct7qzh-qBnloP-R1U9", "3IaeF2-IRMJvH-akxh", "hGDD59-9cQwLf-jsGT", "dMfhjy-v6eLUx-qYWq", "bTHKRF-1HMcaz-G92g", "H8evL9-vzgiKI-dz58", "a7hWjn-bbTyA8-VhYb", "5p8Wuu-CTgjLs-4uBQ", "Zz5rwA-v0gRkT-kbEq", "lQI4Gh-0TiILX-VmEn", "P6Vw8o-nUoMPd-hfK7", "eChIPY-2uFRmC-SQIY", "zCjaIy-O3Ueog-RQN5", "UMhTgz-dCgnWl-KMy1", "NugLd9-VwKl1r-9QOx", "79h1fL-pcPhqa-vzrd", "XC8zOp-3kcFO4-mDow", "YMBWOY-nI0IOw-W9lA", "HEp35B-RRf8MY-F8bN", "4zg9Vc-qxQBxo-x5oQ", "WcbE5t-MdF9O3-nX57", "g219YT-v2ngkK-J0cK", "nY3AvK-CVbxCK-vxKj", "hRsZ8E-Qf2pzb-tSUZ", "ILLEhp-X93VYk-Ocdv", "tmVwLv-DK3l1n-Gsql", "FcGTuS-Kaf0U0-mK6L", "um4Jnj-pl2QWp-bDSu", "aiVm4J-G9HRb6-tlI1", "NnIhLb-Bh8Jm7-x46J", "snOwwf-nC6rV0-NRHT", "DqQesp-Z1xWRd-Cq0u", "uD3fDb-FPsbVq-zRuV", "zhgyzk-14A2Qi-i0t3", "7DeuQL-MGU7CU-jjrV", "snexik-dGp9qp-G80o", "ksBtLX-Buesxm-B4iu", "ENzRuu-w8wo6V-ipDZ", "7wflcR-v8qAcV-X2Mb", "pmvyQ2-ie7GGE-PLeJ", "2M5QDr-Q8zc0p-eRvv", "u6HOCe-bdmjYx-aC8F", "sexqH1-jvbqv9-LFso", "VZdDWy-b2g6sE-5GHb", "1M5Txn-ABVuBT-U3Ee", "H0WBOZ-FU1svd-Fqa0", "8guTQ2-JfWwQF-dPgi", "QAEyrC-lQzSd9-KjBP", "PBo062-9zXvjS-yJNg", "uDZGF3-Nklhdu-I4Xb", "qnDr16-i7PIu7-Xmom", "Ugwpla-UIfX9K-u6C3", "nWOPWf-P9XLuY-OZpz", "dcYY0J-KdgcPD-yCFp", "AfoLze-wLDv6N-RB5Q", "10HR8o-TMLW5S-Gf2Z", "GpW1v2-IXaiq0-82nN", "UXyJD3-EscH2c-kBul", "9mLz69-MyWbSr-hzFk", "R4nB3M-2Wp4xG-zuqL", "taY8XD-bKGFbp-4ZfX", "o3iPrr-VA4WUP-qI0v", "gBNeca-81Gb2u-a7Mz", "Waj2fb-Km2OMk-SmSx", "iFWxkW-kKHWSM-aPwc", "Kxz2jf-27oayH-ChRq", "ldKWUe-Mly1Dl-vbYW", "xmJfrT-kkymaq-jpbV", "GLC94d-a3cenc-XEjM", "SLv9oS-5h1xLL-5Swl", "01xYzd-jJk3P9-bvwf", "OBrJeW-z9zm2S-n7ep", "sE2T2H-P9WQ8y-MpUJ", "xrPZXc-oOyeWg-KCZr", "E57Kd8-cxT8EI-S0Uf", "eRpWmb-y9ekih-cicQ", "TswZ7d-czskna-6hFA"
        ];
        
        // 年度会员兑换码（从兑换码.txt文件导入）
        const annualCodes = [
            "1IBElM-WugWZE-SDFp", "BAEIZB-KauzRG-ovjw", "txrbA1-vbZ50X-gk99", "UytKDg-SNZPYz-S99k", "f1Dk0X-mKZSkA-4Xe3", "2GW7j5-KxBuHP-XJ7y", "KnbNv1-JKRmJp-IEoH", "thPmde-zL1H8n-4nvY", "SlBgGi-sLpasU-ny4L", "2bO2tf-1aEH13-D5FW", "hHTLGh-yrMzJZ-FRSu", "udzanT-J1Yc6c-cAFM", "2IRZWy-syW420-WXMo", "jLhcXt-5yxY7K-LQed", "M4z5Cg-kN0FLy-UUe1", "MUeMp5-nrj8Zo-BPVO", "y7W3x3-wOn4Y3-Y1MY", "GKTCjg-OaJawk-Knmr", "N9oEnh-HwQfEo-BEC1", "DkVRBu-wriIs8-ilSq", "6rR1xb-jc3zEa-XGiJ", "gWSThF-7A0mzg-je0f", "toMDSr-eYw1IP-aXf7", "DBqSRo-GJO4M5-pXQi", "W3wZY9-dMiwvV-Pi3K", "JmnOo0-fkKZfO-3xqZ", "g2w4ss-apYheB-GR31", "y6CeqJ-XZBDSo-rEtE", "SvP6Cr-tRZUUO-xvbv", "xwPHiI-h9NX56-yTzs", "f1epLh-jNDuk8-uWtj", "HtvW4A-dzY3Y7-PVv6", "UGAAPU-UCRn3F-u6Ku", "2krtL8-JvwaOz-9GpH", "le2nmV-HaKvJK-Gk7g", "GarP7z-tcTHsf-hTJD", "QpkiaP-oj6pkL-S2XS", "KoZpkk-zvmFyF-DmmX", "vUZ3bO-OC5KI3-v3Ni", "3n0ii3-mLUO7X-oN8I", "Fh4qna-LhB6vt-p7Gj", "zhJ9TJ-4o1vNM-Il7L", "DCC84Y-NaIilb-iEw3", "NqvC3U-2aEfmZ-pm28", "xrUaAn-XPwLko-oNoD", "QJ0vjn-PDFL65-i0ns", "9W0SX4-hMvr5E-14dP", "cWGiWN-wJQaMu-bO4O", "z2mFCO-d2sp80-D00S", "M0AGyY-A4lSvA-vhno", "N06TmH-BrKYn2-L9bF", "iDRXja-AZDGYz-stRt", "nETJds-84imK6-36kB", "Oh20S1-Moi84J-cQDj", "gg445S-fktv2a-ZXLP", "wBFkGV-e7tenM-AaXc", "TmyRhH-KGhqwM-DOAd", "ali7DI-MrKP8R-BusV", "drMCA5-PMXaoT-O6ZE", "gRZtnZ-qD9rFG-iQem", "NfG8aX-EoefwD-5y4A", "g0DX1X-pJ6f5m-F4nR", "WUAQ9h-ThQAJ2-gyBe", "Uxt2IM-pREnr8-fwxA", "eakCdK-CJGue4-l4nr", "KM57sa-a6ZzxD-ccjA", "alcSvX-Ip1gIL-0Fdo", "UL0WOJ-SuCXdK-gbqL", "x5XwPN-zgf9qu-BJNT", "NhPYod-zv3sJW-G3e5", "29rf1r-PQKioF-Kdyb", "chylMr-M7uLsH-0L1u", "pZdfvb-SX79Bc-6QSs", "gEptR3-acYEsz-Y2kD", "pRpmJC-xNwa3O-1iST", "9eV3WH-eWU22j-iz4w", "fPm2Aq-ty1bSo-GwWT", "cwArea-XGmSgh-kyqF", "wUNvb4-tfTKUi-cVLa", "fYIQ1U-moe7IU-ZNz2", "MVstmw-fpH8KZ-ghN0", "1M6kac-BbtTqK-NUk8", "16PUxH-V3QxTc-f8MK", "M5nIj8-ZEQoT6-7k8P", "Klz7K2-KbQk5B-HguE", "8Kt2Ac-h5HgfD-6RIu", "m0rqV4-FDyDjS-TbrV", "x13EIj-qoibri-PIPU", "psmRp8-RqEE6r-2Zfp", "6sf3AL-mBb6Dy-6sHA", "XGBHjr-nywtvf-dia1", "utdRjH-L3Exrk-uaan", "0FyPUw-agaJu3-Koy0", "CB6Qq3-id8svq-34m5", "tmLAQD-7kATJ7-xcH5", "CPlfWk-Z7KyPf-9WEp", "douAoI-eAwxGr-ynpG", "NUb58X-Yzfq68-4ArY", "RYzEmE-z055Jr-1lo9", "3kTo8L-4itLJv-JgXp", "yoss2j-i2nMJt-audT", "6wN0Tt-SAlfxy-pRP5", "iJ59oZ-kXOVRd-tpdT", "xIivNe-7VT621-hKW0", "Ohfhh9-Dw1sor-fSL5", "JmbCVW-FEzD3g-pXXR", "qipr2c-ZI5FZl-m4ur", "fWx8r3-zVtSSw-vPG8", "ykY1wg-GyxIT7-80Eg", "qqgyml-51qVrm-aoUb", "W0g5ay-kJWxOh-xojF", "erTLpA-bb37ic-Wobd", "yN17Vy-fvDhsb-Y2H7", "H3FDmc-zPgIiS-rU1X", "vUiiPk-RcJgua-aqKs", "TlXq2k-Ji8oL8-6bOL", "CbtMJV-P0BGU4-0l2v", "mNssOF-W594sI-MKl9", "KhDcAG-Vmq39f-XIvQ", "NXYYWy-VKD2O5-7zMb", "RADfoT-RscvYj-QLse", "rvEbuM-s4VKZ3-qUMs", "fDSNyr-HEssej-Zvz1", "hUwYuS-hVipbL-CrQf", "qWjQJk-INndj7-GHBk", "1CX9kW-GNlLwZ-rl4l", "NPIgcr-Xscq7m-AKyc", "5K7zfl-xz7h8K-tF6p", "D6dwyu-1J3D3i-y8CD", "9DuQDe-tYyRSH-f75U", "cFmYKI-jF86nW-o1uH", "OonuBb-6VXG1S-JBw0", "Slfpmv-1Vpdj6-Q5Py", "KYvGym-JKNnJt-Lj3h", "V3AlVw-7WhoYw-gF7y", "LQ4lap-ZeyzsF-k6No", "Vmtolf-NdctDd-Mnu8", "qTSB5z-a9J57f-hdFI", "lRiS91-oSvZE1-vJNq", "mmxGFZ-gqeFNw-M0gt", "avPTg6-b8IodC-aXKI", "8bnRb5-tZ8zPw-b7tR", "AXizP3-8qTkkb-Y78H", "m9br4q-jWifjx-ARBP", "XqLq8v-GuK9c4-ACVC", "KOys2F-fKRkuf-SiW2", "8K5oaZ-lFYxCa-u6UP", "zPWwfh-K8J150-0bIx", "BPWECq-u023JS-iYa6", "4XlkBU-0Lvo9U-Q2X0", "XFRFaT-gjMwfn-iYdd", "uejFpQ-ZvBAwG-MMD8", "M4jF4A-UoIfQm-7Bph", "vZTQKG-mPO09H-ypZC", "lEaXko-TMm4ZW-ONGU", "pC5N9c-KSIBJ5-0uTG", "YhSZVC-AcUZs1-XFrr", "PpeGhb-LSiiC6-lCgy", "SVZsa3-ylLagw-xHYn", "SODSjn-zVRaFV-owWR", "KzXWCl-7pXKja-Pq3s", "Bq0UN7-mmVjUu-AdTG", "lcAarM-AgiLJf-VFWA", "XfZVRX-Lw0SWv-xZXM", "Uh6Y6V-cyAmb8-3o4r", "Mvi6Ud-s2mA7n-DZem", "DP8mk5-kKSoLV-gzwZ", "3rEoyo-dU64yZ-Tk6W", "yXvlU0-Shuapw-fsCx", "UaSIMq-yEllE9-FpSm", "LzECLB-92FAgc-zjjA", "tBkPCf-ywygXV-Piqo", "T5TgdT-2XU3uP-0okO", "h28I6h-Vyk7o9-c8tK", "FRh4Gg-SnKyei-pEgo", "SnEXA5-Od09SZ-JNce", "qCZvuo-BFLUbU-yAml", "uWqbEL-QvV7e0-h7zG", "iJZQOP-5uRMZ5-UslY", "cP3Px2-3dphDT-kwmH", "bmmP3e-FGHqgX-iAND", "ixpUX2-IbMYEH-E1C6", "9O9mn3-XRnJJh-TPYo", "dKGsWL-v2CTIR-Kjmr", "B9uGM6-8vOtVe-1FGw", "L6CEcZ-9FEJ7w-d2XT", "HP6vkG-o7K9Zw-p3C9", "OPTZAk-xz26CO-d0Ef", "gfJkgg-p2Fkok-vZjC", "cuWQ8C-WkcOOw-OBNr", "dXrbK1-G8LgJD-dWkj", "zCpq1f-9taXh2-AtmU", "35LGMJ-JtzsQt-eg6Q", "3kqFt9-oBRluk-AKBF", "OMyth4-DIH36o-g1av", "lmvTDQ-AEPavW-akXg", "ZjC1Qp-aRW7DF-JmgV", "jeUOGN-nOhbgU-72Y8", "HG7CP9-v3sSSm-UBpO", "yyolSP-I5ndHv-vHAe", "Z1kxn2-PSdy8N-9htj", "9S3xM4-PdHHYK-8CVl", "L9mePE-PDBbTJ-XWcx", "shmVg5-un5est-Vrzj", "uYTDBz-n23V62-Jw6G", "sCPHu0-OAmlhr-TKYT", "gEpTdX-MFcHO5-h7hS", "gTcOpt-bZR6nR-bJr4", "Or6hQg-ahwHnr-FTVx", "dp0bkT-OZS7cO-ksyF", "W6vJtz-befdK0-kCFi", "J2dpxO-VT1vxQ-oVhY", "Feo0T5-81R2PA-Z18h", "IDvBaa-6TWDl0-ZwtY", "kehAiT-6sUHjb-sygw", "Kh3Mcg-w62JQC-j5D3", "qAl8Mn-TQojcz-w3K1", "rarDPK-8ZAMJ4-2cNQ", "ZHzqij-z901sA-FjUP", "4PNVgt-DXMQT2-P4Cd", "FhFeSQ-qbZlIK-3Iia", "tZ3dOW-Wzzru4-upVl", "45TTA6-W38TXp-6IBN", "PLKEYP-i0FLa5-opRD", "WQ6g2S-YacJrX-LdUq", "445Mfy-1bVqa6-VYcL", "j88JI2-OTLfuF-kmI5", "eBJFWH-tWtz8j-mxZq", "gUTEfX-oNBsxe-52LH", "TbXjGg-vMIySV-9zEI", "gt3TgK-slhmWV-jvbh", "y633Ae-SLCzsJ-WQuN", "HZ7RgB-y5lVld-XVBu", "zZUloM-ctgh2d-dj8T", "HK13Fu-2pV3wb-buWx", "LDuMEJ-CysVP3-9M60", "cuoCMf-slUI6f-QxCe", "SkwF0i-uE6AR9-e0LV", "2n9FFt-JAvciU-3U2s", "39z8Wk-r7M6J6-0bHI", "00PoAB-J5Ftjw-OXNq", "Nqa2ZJ-KzAR6j-iMpb"
        ];
        
        // 合并所有类型的兑换码
        const validRedeemCodes = [...monthlyCodes, ...quarterlyCodes, ...annualCodes];
        
        // 当前选择的会员类型
        let selectedMembershipType = 'monthly';
        
        // 当前反馈的单词ID
        let currentFeedbackWordIndex = -1;
        let isReviewMode = false;
        
        // AI分析使用次数管理
        let aiUsageCount = 1;
        let lastResetDate = new Date().toDateString();
        
        // 有效邀请码列表
        const validInviteCodes = ['571501', '163064', '497797', '557238', '208597', '108742', '193555', '646806', '675515', '155310', '103984', '916388', '658320', '909855', '113547', '205900'];
        
        // 初始化使用次数
        function initUsageCount() {
            const savedData = localStorage.getItem('aiUsageData');
            if (savedData) {
                const data = JSON.parse(savedData);
                const today = new Date().toDateString();
                
                // 检查是否需要重置使用次数
                if (data.lastResetDate !== today) {
                    // 每日重置为1次
                    aiUsageCount = 1;
                    lastResetDate = today;
                    saveUsageData();
                } else {
                    // 恢复保存的使用次数
                    aiUsageCount = data.usageCount;
                    lastResetDate = data.lastResetDate;
                }
            } else {
                // 首次使用，初始化数据
                saveUsageData();
            }
            
            // 更新使用次数显示
            updateUsageCountDisplay();
        }
        
        // 保存使用次数数据
        function saveUsageData() {
            const data = {
                usageCount: aiUsageCount,
                lastResetDate: lastResetDate
            };
            localStorage.setItem('aiUsageData', JSON.stringify(data));
        }
        
        // 更新使用次数显示
        function updateUsageCountDisplay() {
            const usageCountElement = document.getElementById('usageCount');
            if (usageCountElement) {
                usageCountElement.textContent = aiUsageCount;
            }
        }
        
        // 检查使用次数
        function checkUsageCount() {
            if (aiUsageCount <= 0) {
                // 显示邀请码输入弹窗
                document.getElementById('inviteCodeModal').classList.remove('hidden');
                return false;
            }
            return true;
        }
        
        // 减少使用次数
        function decreaseUsageCount() {
            aiUsageCount--;
            saveUsageData();
            updateUsageCountDisplay();
        }
        
        // 增加使用次数
        function increaseUsageCount(amount) {
            aiUsageCount += amount;
            saveUsageData();
            updateUsageCountDisplay();
        }
        
        // 验证邀请码
        function verifyInviteCode() {
            const inviteCodeInput = document.getElementById('inviteCodeInput');
            const inviteCode = inviteCodeInput.value.trim();
            
            if (!inviteCode) {
                showModal('提示', '请输入邀请码', 'info');
                return;
            }
            
            if (validInviteCodes.includes(inviteCode)) {
                // 邀请码有效，增加15次使用次数
                increaseUsageCount(15);
                
                // 显示成功提示
                showModal('邀请码验证成功', `您的每日使用次数已增加15次，当前剩余次数：${aiUsageCount}次`, 'success');
                
                // 关闭邀请码弹窗
                document.getElementById('inviteCodeModal').classList.add('hidden');
                
                // 清空输入框
                inviteCodeInput.value = '';
            } else {
                // 邀请码无效
                showModal('邀请码验证失败', '请输入有效的邀请码', 'error');
            }
        }
        
        // 执行AI分析
        async function performAIAnalysis() {
            // 显示加载状态
            document.getElementById('aiAnalysisLoading').classList.remove('hidden');
            document.getElementById('aiAnalysisResult').classList.add('hidden');
            
            try {
                // 提取用户学习数据
                const learningData = extractLearningData();
                
                let analysisResult;
                
                // 强制使用OpenRouter API分析
                console.log('强制使用OpenRouter API分析');
                
                try {
                    // 构建AI分析请求
                    const analysisRequest = buildAnalysisRequest(learningData);
                    
                    // 调用OpenRouter API
                    console.log('尝试调用OpenRouter API');
                    analysisResult = await callOpenRouterAPI(analysisRequest);
                } catch (apiError) {
                    console.error('API调用失败:', apiError);
                    // 即使API调用失败，也不使用本地模拟，显示错误信息
                    throw new Error('AI分析API调用失败，请检查网络连接或稍后重试');
                }
                
                // 显示分析结果
                displayAnalysisResult(analysisResult);
            } catch (error) {
                console.error('AI分析失败:', error);
                showModal('分析失败', error.message || 'AI分析过程中发生错误，请稍后重试', 'error');
                document.getElementById('aiAnalysisModal').classList.add('hidden');
            }
        }
        
        // 生成本地模拟的AI分析结果
        function generateLocalAnalysis(learningData) {
            const { totalWords, totalLearned, totalWrong, correctRate } = learningData;
            
            // 生成基于数据的分析结果
            let analysisText = `# 学习数据分析报告\n\n`;
            
            // 学习状况总体分析
            analysisText += `## 1. 学习状况总体分析\n\n`;
            analysisText += `- 总单词数：${totalWords}\n`;
            analysisText += `- 已学单词数：${totalLearned}\n`;
            analysisText += `- 错题数：${totalWrong}\n`;
            analysisText += `- 正确率：${correctRate}%\n\n`;
            
            // 学习评估
            if (correctRate >= 80) {
                analysisText += `您的学习状况非常良好，正确率很高，继续保持！\n\n`;
            } else if (correctRate >= 60) {
                analysisText += `您的学习状况良好，但仍有提升空间，建议加强练习。\n\n`;
            } else {
                analysisText += `您的学习状况需要改进，建议增加练习时间，重点关注错题。\n\n`;
            }
            
            // 常见错误类型分析
            analysisText += `## 2. 常见错误类型分析\n\n`;
            analysisText += `- 拼写错误：可能是对单词拼写规则掌握不够牢固\n`;
            analysisText += `- 记忆混淆：可能是相似单词之间的区分不够清晰\n`;
            analysisText += `- 反应速度：可能是对单词的熟悉度不够\n\n`;
            
            // 学习建议和改进方向
            analysisText += `## 3. 学习建议和改进方向\n\n`;
            analysisText += `- 增加每日学习时间，保持学习的连续性\n`;
            analysisText += `- 重点复习错题，加强记忆\n`;
            analysisText += `- 使用联想记忆法，提高记忆效果\n`;
            analysisText += `- 多做练习，提高单词的熟悉度\n`;
            analysisText += `- 定期回顾已学单词，防止遗忘\n\n`;
            
            // 个性化学习计划建议
            analysisText += `## 4. 个性化学习计划建议\n\n`;
            analysisText += `- 每日学习目标：建议每天学习10-15个新单词\n`;
            analysisText += `- 复习计划：每3天复习一次已学单词\n`;
            analysisText += `- 错题复习：每天复习5-10个错题\n`;
            analysisText += `- 学习时间：建议每天学习20-30分钟，保持专注\n`;
            analysisText += `- 学习方法：结合视觉、听觉和触觉多种感官进行学习\n\n`;
            
            analysisText += `**提示**：由于您是直接打开HTML文件，此分析结果为本地模拟生成。要获得更准确的AI分析结果，请通过本地服务器访问应用。`;
            
            return analysisText;
        }
        
        // 提取用户学习数据
        function extractLearningData() {
            // 从appState中提取学习数据
            const { words, learnedWords, wrongWords, history } = appState;
            
            // 计算学习统计数据
            const totalWords = words.length;
            const totalLearned = learnedWords.length;
            const totalWrong = wrongWords.length;
            
            // 计算正确率
            let correctCount = 0;
            let totalAttempts = 0;
            
            history.forEach(item => {
                totalAttempts++;
                if (item.result === '正确') {
                    correctCount++;
                }
            });
            
            const correctRate = totalAttempts > 0 ? Math.round((correctCount / totalAttempts) * 100) : 0;
            
            // 提取最近的学习记录
            const recentHistory = history.slice(0, 20);
            
            return {
                totalWords,
                totalLearned,
                totalWrong,
                correctRate,
                recentHistory,
                words: words.slice(0, 50) // 只提取前50个单词，避免数据过大
            };
        }
        
        // 构建AI分析请求
        function buildAnalysisRequest(learningData) {
            return {
                model: "meta-llama/llama-3.3-70b-instruct:free",
                messages: [
                    {
                        "role": "system",
                        "content": "你是一个专业的英语学习数据分析助手，负责分析用户的学习数据并提供有价值的学习建议。"
                    },
                    {
                        "role": "user",
                        "content": `请分析以下单词学习数据，并提供详细的学习分析报告和改进建议：\n\n学习统计：\n- 总单词数：${learningData.totalWords}\n- 已学单词数：${learningData.totalLearned}\n- 错题数：${learningData.totalWrong}\n- 正确率：${learningData.correctRate}%\n\n最近学习记录：\n${learningData.recentHistory.map(item => `- ${item.english} (${item.chinese}) - ${item.result}`).join('\n')}\n\n部分单词：\n${learningData.words.map(item => `- ${item.english}: ${item.chinese} (正确: ${item.correct}, 错误: ${item.wrong})`).join('\n')}\n\n请提供：\n1. 学习状况总体分析\n2. 常见错误类型分析\n3. 学习建议和改进方向\n4. 个性化学习计划建议`
                    }
                ],
                stream: false
            };
        }
        
        // 调用硅基流动API
        async function callOpenRouterAPI(request) {
            try {
                // 安全存储API密钥（实际生产环境中应使用更安全的存储方式）
                const apiKey = 'sk-cenuszepfuhakzescshozaebqcicrpjltgjaiqmfndqwjgjl';
                
                console.log('正在调用硅基流动API...');
                
                // 尝试使用直接API调用（不依赖SDK）
                const response = await fetch('https://api.siliconflow.cn/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-ai/DeepSeek-R1-0528-Qwen3-8B",
                        messages: request.messages,
                        max_tokens: 1000,
                        temperature: 0.7,
                        stream: request.stream
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                }
                
                const responseData = await response.json();
                console.log('API调用成功:', responseData);
                
                // 处理响应
                const fullResponse = responseData.choices[0]?.message?.content || '';
                return fullResponse;
            } catch (error) {
                console.error('API调用失败:', error);
                throw error;
            }
        }
        
        // 显示分析结果
        function displayAnalysisResult(result) {
            // 隐藏加载状态
            document.getElementById('aiAnalysisLoading').classList.add('hidden');
            
            // 显示分析结果
            const resultElement = document.getElementById('aiAnalysisResult');
            resultElement.classList.remove('hidden');
            
            // 填充分析结果
            const proseElement = resultElement.querySelector('.prose');
            proseElement.innerHTML = result;
        }

        // 数据模型
        const appState = {
            words: [
                { english: "apple", chinese: "苹果", correct: 0, wrong: 0 },
                { english: "banana", chinese: "香蕉", correct: 0, wrong: 0 },
                { english: "cherry", chinese: "樱桃", correct: 0, wrong: 0 },
                { english: "date", chinese: "枣", correct: 0, wrong: 0 },
                { english: "elderberry", chinese: "接骨木果", correct: 0, wrong: 0 },
                { english: "fig", chinese: "无花果", correct: 0, wrong: 0 },
                { english: "grape", chinese: "葡萄", correct: 0, wrong: 0 },
                { english: "honeydew", chinese: "蜜瓜", correct: 0, wrong: 0 },
                { english: "kiwi", chinese: "猕猴桃", correct: 0, wrong: 0 },
                { english: "lemon", chinese: "柠檬", correct: 0, wrong: 0 },
                { english: "mango", chinese: "芒果", correct: 0, wrong: 0 },
                { english: "nectarine", chinese: "油桃", correct: 0, wrong: 0 },
                { english: "orange", chinese: "橙子", correct: 0, wrong: 0 },
                { english: "peach", chinese: "桃子", correct: 0, wrong: 0 },
                { english: "quince", chinese: "榅桲", correct: 0, wrong: 0 },
                { english: "raspberry", chinese: "树莓", correct: 0, wrong: 0 },
                { english: "strawberry", chinese: "草莓", correct: 0, wrong: 0 },
                { english: "tangerine", chinese: "橘子", correct: 0, wrong: 0 },
                { english: "watermelon", chinese: "西瓜", correct: 0, wrong: 0 },
                { english: "zucchini", chinese: "西葫芦", correct: 0, wrong: 0 },
            ],
            learnedWords: [],
            wrongWords: [],
            currentWordIndex: 0,
            currentReviewWordIndex: 0,
            reviewWords: [], // 当前复习的单词列表
            settings: {
                showFirstLetter: true,
                showWordLength: true
            },
            history: [],
            dailyGoal: 20,
            today: new Date().toDateString(),
            todayLearned: 0,
            sessionWords: [] // 当前学习会话的单词
        };

        // DOM元素
        const sections = {
            welcome: document.getElementById('welcome'),
            dashboard: document.getElementById('dashboard'),
            learn: document.getElementById('learn'),
            review: document.getElementById('review'),
            settings: document.getElementById('settings'),
            redeemCode: document.getElementById('redeemCode')
        };

        // 模态框元素
        const modal = {
            element: document.getElementById('modal'),
            icon: document.getElementById('modalIcon'),
            title: document.getElementById('modalTitle'),
            message: document.getElementById('modalMessage'),
            closeBtn: document.getElementById('closeModal')
        };

        // 初始化应用
        function initApp() {
            // 初始化开始时间（使用多重存储验证）
            initAppStartTime();
            
            // 启动时间完整性检查
            startTimeIntegrityCheck();
            
            // 监听页面可见性变化
            initVisibilityListener();
            
            // 检查会员状态
            const savedMembership = localStorage.getItem('membershipVerified');
            if (savedMembership === 'true') {
                membershipVerified = true;
            } else {
                // 设置30分钟后显示会员提示
                setTimeout(() => {
                    if (!membershipVerified && checkTimeLimit()) {
                        checkUsageTime();
                    }
                }, USAGE_TIME_LIMIT);
            }

            // 初始化AI使用次数
            initUsageCount();

            // 加载本地存储的数据
            loadFromLocalStorage();
            
            // 设置导航栏滚动效果
            window.addEventListener('scroll', () => {
                const navbar = document.getElementById('navbar');
                if (window.scrollY > 10) {
                    navbar.classList.add('py-2');
                    navbar.classList.remove('py-3');
                } else {
                    navbar.classList.add('py-3');
                    navbar.classList.remove('py-2');
                }
            });

            // 移动端菜单切换
            document.getElementById('menuToggle').addEventListener('click', () => {
                const mobileMenu = document.getElementById('mobileMenu');
                mobileMenu.classList.toggle('hidden');
            });

            // 导航链接事件
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    showSection(targetId.substring(1));
                    if (window.innerWidth < 768) {
                        document.getElementById('mobileMenu').classList.add('hidden');
                    }
                });
            });

            // 开始学习按钮
            document.getElementById('startBtn').addEventListener('click', () => {
                startLearning();
            });

            // 返回仪表盘按钮
            document.getElementById('backToDashboard').addEventListener('click', () => {
                showSection('dashboard');
                updateDashboard();
            });

            // 返回仪表盘(复习)按钮
            document.getElementById('backFromReview').addEventListener('click', () => {
                showSection('dashboard');
                updateDashboard();
            });

            // 检查答案按钮
            document.getElementById('checkBtn').addEventListener('click', checkAnswer);
            document.getElementById('answerInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') checkAnswer();
            });

            // 下一个单词按钮
            document.getElementById('nextBtn').addEventListener('click', nextWord);

            // 复习检查答案按钮
            document.getElementById('reviewCheckBtn').addEventListener('click', checkReviewAnswer);
            document.getElementById('reviewAnswerInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') checkReviewAnswer();
            });

            // 复习下一个单词按钮
            document.getElementById('reviewNextBtn').addEventListener('click', nextReviewWord);

            // 显示提示按钮
            document.getElementById('showHint').addEventListener('click', showHint);
            document.getElementById('reviewHint').addEventListener('click', showReviewHint);

            // 导出按钮
            document.getElementById('exportBtn').addEventListener('click', exportHistory);

            // 保存设置按钮
            document.getElementById('saveSettings').addEventListener('click', saveSettings);

            // 添加单词按钮
            document.getElementById('addWordBtn').addEventListener('click', addNewWord);

            // 单词文件选择
            document.getElementById('wordFile').addEventListener('change', (e) => {
                const fileName = e.target.files[0]?.name || '未选择文件';
                document.getElementById('fileName').textContent = fileName;
            });

            // 导入单词按钮
            document.getElementById('importWordsBtn').addEventListener('click', importWords);

            // 删除所有单词按钮
            document.getElementById('deleteAllWords').addEventListener('click', deleteAllWords);

            // 导出所有单词按钮
            document.getElementById('exportAllWords').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('exportFormatMenu').classList.toggle('hidden');
            });

            // 点击其他地方关闭导出格式菜单
            document.addEventListener('click', (e) => {
                const exportBtn = document.getElementById('exportAllWords');
                const menu = document.getElementById('exportFormatMenu');
                if (!exportBtn.contains(e.target) && !menu.contains(e.target)) {
                    menu.classList.add('hidden');
                }
            });

            // 导出为TXT
            document.getElementById('exportAsTxt').addEventListener('click', () => {
                exportWords('txt');
                document.getElementById('exportFormatMenu').classList.add('hidden');
            });

            // 导出为Excel
            document.getElementById('exportAsExcel').addEventListener('click', () => {
                exportWords('excel');
                document.getElementById('exportFormatMenu').classList.add('hidden');
            });

            // 重置学习进度按钮
            document.getElementById('resetProgress').addEventListener('click', resetProgress);

            // 删除所有数据按钮
            document.getElementById('deleteAllData').addEventListener('click', deleteAllData);

            // 关闭模态框按钮
            modal.closeBtn.addEventListener('click', () => {
                modal.element.classList.add('hidden');
            });

            // 关闭更新说明模态框
            document.getElementById('closeUpdateModal').addEventListener('click', () => {
                document.getElementById('updateModal').classList.add('hidden');
            });

            // 反馈相关事件
            document.getElementById('disagreeBtn').addEventListener('click', () => {
                isReviewMode = false;
                currentFeedbackWordIndex = appState.currentWordIndex;
                document.getElementById('feedbackModal').classList.remove('hidden');
            });

            document.getElementById('reviewDisagreeBtn').addEventListener('click', () => {
                isReviewMode = true;
                currentFeedbackWordIndex = appState.currentReviewWordIndex;
                document.getElementById('feedbackModal').classList.add('hidden');
                document.getElementById('feedbackModal').classList.remove('hidden');
            });

            document.getElementById('cancelFeedback').addEventListener('click', () => {
                document.getElementById('feedbackModal').classList.add('hidden');
            });

            document.getElementById('submitFeedback').addEventListener('click', submitFeedback);

            // 其他原因显示/隐藏
            document.querySelectorAll('input[name="feedbackReason"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    const otherReasonContainer = document.getElementById('otherReasonContainer');
                    if (document.getElementById('reason3').checked) {
                        otherReasonContainer.classList.remove('hidden');
                    } else {
                        otherReasonContainer.classList.add('hidden');
                    }
                });
            });

            // 复习完成相关按钮
            document.getElementById('reviewAgainBtn').addEventListener('click', reviewAgain);
            document.getElementById('finishReviewBtn').addEventListener('click', finishReview);
            document.getElementById('backAfterReviewBtn').addEventListener('click', () => {
                showSection('dashboard');
                updateDashboard();
            });

            // 导出错题按钮
            document.getElementById('exportWrongWordsBtn').addEventListener('click', exportWrongWords);

            // 重新开始学习按钮
            document.getElementById('restartLearnBtn').addEventListener('click', restartLearning);

            // 修改单词相关事件
            document.getElementById('cancelEditWord').addEventListener('click', () => {
                document.getElementById('editWordModal').classList.add('hidden');
            });

            document.getElementById('saveEditWord').addEventListener('click', saveEditedWord);

            // 会员相关事件
            document.getElementById('alreadyPurchased').addEventListener('click', () => {
                document.getElementById('membershipTypeContainer').classList.remove('hidden');
                document.getElementById('modalRedeemCodeContainer').classList.remove('hidden');
            });
            
            // 购买会员按钮点击事件
            document.getElementById('buyMembershipDirect').addEventListener('click', () => {
                window.open('https://dancibaovip.netlify.app/', '_blank', 'noopener,noreferrer');
            });

            // 会员类型选择事件
            document.querySelectorAll('.membership-type-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // 移除所有按钮的active类
                    document.querySelectorAll('.membership-type-btn').forEach(b => {
                        b.classList.remove('active');
                        b.classList.remove('bg-primary', 'text-white');
                        b.classList.add('bg-gray-200', 'text-gray-800');
                    });
                    // 为当前按钮添加active类
                    e.target.classList.add('active');
                    e.target.classList.remove('bg-gray-200', 'text-gray-800');
                    e.target.classList.add('bg-primary', 'text-white');
                    // 更新当前选择的会员类型
                    selectedMembershipType = e.target.dataset.type;
                });
            });

            // 为模态框中的验证按钮添加事件监听器
            document.getElementById('modalVerifyCode').addEventListener('click', verifyRedeemCode);
            // 为核销兑换码页面中的验证按钮添加事件监听器
            document.querySelectorAll('#verifyCode').forEach(btn => {
                btn.addEventListener('click', verifyRedeemCode);
            });

            // 会员中心下拉菜单交互
            const membershipCenterBtn = document.getElementById('membershipCenterBtn');
            const membershipDropdown = document.getElementById('membershipDropdown');
            const redeemCodeLink = document.getElementById('redeemCodeLink');
            
            // 点击会员中心按钮显示/隐藏下拉菜单
            membershipCenterBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                membershipDropdown.classList.toggle('hidden');
            });
            
            // 点击核销兑换码链接导航到核销页面
            redeemCodeLink.addEventListener('click', (e) => {
                e.stopPropagation();
                membershipDropdown.classList.add('hidden');
                // 导航到核销兑换码页面
                showSection('redeemCode');
            });
            
            // 点击页面其他区域关闭下拉菜单
            document.addEventListener('click', (e) => {
                if (!membershipCenterBtn.contains(e.target) && !membershipDropdown.contains(e.target)) {
                    membershipDropdown.classList.add('hidden');
                }
            });
            
            // AI分析按钮事件
            document.getElementById('aiAnalysisBtn').addEventListener('click', () => {
                if (checkUsageCount()) {
                    // 减少使用次数
                    decreaseUsageCount();
                    
                    // 显示AI分析结果弹窗
                    document.getElementById('aiAnalysisModal').classList.remove('hidden');
                    
                    // 开始AI分析
                    performAIAnalysis();
                }
            });
            
            // 邀请码验证按钮事件
            document.getElementById('verifyInviteCode').addEventListener('click', verifyInviteCode);
            
            // 邀请码取消按钮事件
            document.getElementById('cancelInviteCode').addEventListener('click', () => {
                document.getElementById('inviteCodeModal').classList.add('hidden');
                document.getElementById('inviteCodeInput').value = '';
            });
            
            // AI分析关闭按钮事件
            document.getElementById('closeAiAnalysis').addEventListener('click', () => {
                document.getElementById('aiAnalysisModal').classList.add('hidden');
            });
            
            // AI分析保存按钮事件
            document.getElementById('saveAiAnalysis').addEventListener('click', () => {
                showModal('提示', '分析结果已保存', 'success');
            });

            // 初始化页面
            renderWordsTable();
            renderWrongWordsList();
        }

        // 检查使用时间
        function checkUsageTime() {
            if (!membershipVerified) {
                // 生成随机订单号
                const orderNumber = 'ORD' + Date.now() + Math.floor(Math.random() * 1000);
                document.getElementById('orderNumber').textContent = orderNumber;
                document.getElementById('membershipModal').classList.remove('hidden');
            }
        }

        // 验证兑换码
        function verifyRedeemCode() {
            // 根据当前显示的页面获取正确的兑换码输入框
            let codeInput;
            if (document.getElementById('redeemCode').classList.contains('hidden')) {
                // 从模态框中获取兑换码
                codeInput = document.getElementById('modalRedeemCode');
            } else {
                // 从核销兑换码页面获取兑换码
                codeInput = document.getElementById('redeemCodeInput');
            }
            
            const code = codeInput.value.trim();
            let isValid = false;
            let errorMessage = '';
            
            // 两步验证：
            // 1. 首先检查兑换码是否有效（存在于所有有效兑换码中）
            const codeExists = validRedeemCodes.includes(code);
            
            // 2. 然后检查兑换码是否与当前选择的会员类型匹配
            switch (selectedMembershipType) {
                case 'monthly':
                    isValid = monthlyCodes.includes(code);
                    break;
                case 'quarterly':
                    isValid = quarterlyCodes.includes(code);
                    break;
                case 'annual':
                    isValid = annualCodes.includes(code);
                    break;
            }
            
            if (isValid) {
                membershipVerified = true;
                localStorage.setItem('membershipVerified', 'true');
                // 隐藏可能显示的会员模态框
                document.getElementById('membershipModal').classList.add('hidden');
                showModal('验证成功', '会员已激活，感谢您的支持！', 'success');
                // 如果是在核销兑换码页面，清空输入框
                codeInput.value = '';
            } else {
                // 根据不同错误情况显示不同的错误信息
                if (!codeExists) {
                    errorMessage = '兑换码无效，请检查后重新输入';
                } else {
                    errorMessage = '兑换码与选择的会员类型不匹配，请重新选择会员类型或兑换码';
                }
                showModal('验证失败', errorMessage, 'error');
            }
        }

        // 显示指定区域
        function showSection(sectionId) {
            // 检查会员状态，如果未验证且超过30分钟，显示会员提示
            // 核销兑换码页面不需要检查，直接显示
            if (!membershipVerified && sectionId !== 'welcome' && sectionId !== 'redeemCode' &&
                checkTimeLimit()) {
                checkUsageTime();
                return;
            }

            // 隐藏所有区域
            Object.keys(sections).forEach(key => {
                sections[key].classList.add('hidden');
            });
            
            // 显示指定区域
            if (sections[sectionId]) {
                sections[sectionId].classList.remove('hidden');
                
                // 如果显示的是仪表盘，更新数据
                if (sectionId === 'dashboard') {
                    updateDashboard();
                } 
                // 如果显示的是复习页面，初始化复习
                else if (sectionId === 'review') {
                    initReview();
                }
                // 如果显示的是设置页面，加载设置
                else if (sectionId === 'settings') {
                    loadSettings();
                }
            }
        }

        // 开始学习
        function startLearning() {
            // 检查是否有单词
            if (appState.words.length === 0) {
                showModal('提示', '请先添加单词才能开始学习', 'info');
                return;
            }

            // 选择所有单词进行学习
            appState.sessionWords = [...appState.words];
            // 打乱顺序
            shuffleArray(appState.sessionWords);
            
            appState.currentWordIndex = 0;
            showSection('learn');
            renderCurrentWord();
            updateLearnProgress();
        }

        // 重新开始学习
        function restartLearning() {
            startLearning();
        }

        // 渲染当前单词
        function renderCurrentWord() {
            if (appState.currentWordIndex >= appState.sessionWords.length) {
                showSection('dashboard');
                updateDashboard();
                return;
            }

            const word = appState.sessionWords[appState.currentWordIndex];
            document.getElementById('currentWord').textContent = word.chinese;
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').focus();
            
            // 显示单词卡片，隐藏结果卡片
            document.getElementById('wordCard').classList.remove('hidden');
            document.getElementById('resultCard').classList.add('hidden');
        }

        // 更新学习进度
        function updateLearnProgress() {
            const progressText = `${appState.currentWordIndex + 1}/${appState.sessionWords.length}`;
            document.getElementById('learnProgress').textContent = progressText;
        }

        // 检查答案
        function checkAnswer() {
            const input = document.getElementById('answerInput').value.trim();
            const currentWord = appState.sessionWords[appState.currentWordIndex];
            
            if (!input) {
                showModal('提示', '请输入答案', 'info');
                return;
            }

            // 处理多种正确拼写
            const correctAnswers = currentWord.english.split(',').map(ans => normalizeAnswer(ans));
            const userAnswer = normalizeAnswer(input);
            
            // 检查是否正确
            const isCorrect = correctAnswers.some(ans => ans === userAnswer);
            
            // 显示结果卡片，隐藏单词卡片
            document.getElementById('wordCard').classList.add('hidden');
            document.getElementById('resultCard').classList.remove('hidden');
            
            if (isCorrect) {
                // 正确
                document.getElementById('correctResult').classList.remove('hidden');
                document.getElementById('wrongResult').classList.add('hidden');
                document.getElementById('correctWord').textContent = currentWord.english;
                
                // 更新单词统计
                currentWord.correct++;
                
                // 添加到已学单词
                if (!appState.learnedWords.includes(currentWord.english)) {
                    appState.learnedWords.push(currentWord.english);
                }
                
                // 从错题中移除（如果存在）
                const wrongIndex = appState.wrongWords.findIndex(w => w.english === currentWord.english);
                if (wrongIndex !== -1) {
                    appState.wrongWords.splice(wrongIndex, 1);
                }
                
                // 更新今日学习数量
                if (new Date().toDateString() === appState.today) {
                    appState.todayLearned++;
                } else {
                    appState.today = new Date().toDateString();
                    appState.todayLearned = 1;
                }
                
                // 添加到历史记录
                appState.history.unshift({
                    english: currentWord.english,
                    chinese: currentWord.chinese,
                    result: '正确',
                    date: new Date().toLocaleString()
                });
                
            } else {
                // 错误
                document.getElementById('correctResult').classList.add('hidden');
                document.getElementById('wrongResult').classList.remove('hidden');
                document.getElementById('wrongWord').textContent = currentWord.english;
                
                // 分析错误原因
                const errorReason = getErrorReason(userAnswer, correctAnswers[0]);
                document.getElementById('errorReason').textContent = errorReason;
                
                // 更新单词统计
                currentWord.wrong++;
                
                // 添加到错题
                if (!appState.wrongWords.some(w => w.english === currentWord.english)) {
                    appState.wrongWords.push({...currentWord});
                }
                
                // 添加到历史记录
                appState.history.unshift({
                    english: currentWord.english,
                    chinese: currentWord.chinese,
                    result: '错误',
                    date: new Date().toLocaleString()
                });
            }
            
            // 保存数据
            saveToLocalStorage();
        }

        // 标准化答案（去除空格和点号）
        function normalizeAnswer(answer) {
            return answer.toLowerCase().replace(/[ .]/g, '');
        }

        // 获取错误原因
        function getErrorReason(userAnswer, correctAnswer) {
            if (userAnswer.length !== correctAnswer.length) {
                return `长度不正确，应为${correctAnswer.length}个字符`;
            }
            
            // 找出第一个不同的字符位置
            for (let i = 0; i < Math.min(userAnswer.length, correctAnswer.length); i++) {
                if (userAnswer[i] !== correctAnswer[i]) {
                    return `第${i+1}个字符错误，应为"${correctAnswer[i]}"`;
                }
            }
            
            return "拼写不正确";
        }

        // 提交反馈
        function submitFeedback() {
            if (currentFeedbackWordIndex === -1) return;
            
            // 获取反馈原因
            let reason = document.querySelector('input[name="feedbackReason"]:checked').value;
            if (reason === '其他') {
                reason += '：' + document.getElementById('otherReason').value;
            }
            
            // 记录反馈（实际应用中可能会发送到服务器）
            console.log(`反馈：单词索引${currentFeedbackWordIndex}，原因：${reason}`);
            
            // 更新结果为正确
            if (isReviewMode) {
                const word = appState.reviewWords[currentFeedbackWordIndex];
                // 处理复习模式下的反馈
                document.getElementById('reviewWrongResult').classList.add('hidden');
                document.getElementById('reviewCorrectResult').classList.remove('hidden');
                document.getElementById('reviewCorrectWord').textContent = word.english;
                
                // 从错题中移除
                const wrongIndex = appState.wrongWords.findIndex(w => w.english === word.english);
                if (wrongIndex !== -1) {
                    appState.wrongWords.splice(wrongIndex, 1);
                }
                
                // 更新历史记录
                const historyIndex = appState.history.findIndex(h => h.english === word.english && h.result === '错误');
                if (historyIndex !== -1) {
                    appState.history[historyIndex].result = '正确';
                }
                
                word.correct++;
            } else {
                const word = appState.sessionWords[currentFeedbackWordIndex];
                // 处理学习模式下的反馈
                document.getElementById('wrongResult').classList.add('hidden');
                document.getElementById('correctResult').classList.remove('hidden');
                document.getElementById('correctWord').textContent = word.english;
                
                // 从错题中移除
                const wrongIndex = appState.wrongWords.findIndex(w => w.english === word.english);
                if (wrongIndex !== -1) {
                    appState.wrongWords.splice(wrongIndex, 1);
                }
                
                // 更新历史记录
                const historyIndex = appState.history.findIndex(h => h.english === word.english && h.result === '错误');
                if (historyIndex !== -1) {
                    appState.history[historyIndex].result = '正确';
                }
                
                word.correct++;
                word.wrong--;
            }
            
            // 保存数据
            saveToLocalStorage();
            renderWrongWordsList();
            
            // 关闭反馈模态框
            document.getElementById('feedbackModal').classList.add('hidden');
            showModal('反馈成功', '感谢您的反馈，结果已更新', 'success');
        }

        // 下一个单词
        function nextWord() {
            appState.currentWordIndex++;
            updateLearnProgress();
            
            if (appState.currentWordIndex < appState.sessionWords.length) {
                renderCurrentWord();
            } else {
                // 学习完成
                showSection('dashboard');
                updateDashboard();
                showModal('学习完成', '恭喜你完成了本次学习！', 'success');
            }
        }

        // 初始化复习
        function initReview() {
            // 复制当前错题列表作为复习内容
            appState.reviewWords = [...appState.wrongWords];
            
            if (appState.reviewWords.length === 0) {
                // 没有错题，显示完成界面
                document.getElementById('reviewContent').classList.add('hidden');
                document.getElementById('reviewComplete').classList.remove('hidden');
                document.getElementById('reviewCompleteMessage').textContent = '你目前没有需要复习的错题，继续保持！';
                document.getElementById('reviewAgainSection').classList.add('hidden');
                return;
            }
            
            // 显示复习内容，隐藏完成界面
            document.getElementById('reviewContent').classList.remove('hidden');
            document.getElementById('reviewComplete').classList.add('hidden');
            
            // 打乱顺序
            shuffleArray(appState.reviewWords);
            
            appState.currentReviewWordIndex = 0;
            renderCurrentReviewWord();
            updateReviewProgress();
        }

        // 渲染当前复习单词
        function renderCurrentReviewWord() {
            if (appState.currentReviewWordIndex >= appState.reviewWords.length) {
                finishReviewSession();
                return;
            }

            const word = appState.reviewWords[appState.currentReviewWordIndex];
            document.getElementById('currentReviewWord').textContent = word.chinese;
            document.getElementById('reviewAnswerInput').value = '';
            document.getElementById('reviewAnswerInput').focus();
            
            // 显示单词卡片，隐藏结果卡片
            document.getElementById('reviewCard').classList.remove('hidden');
            document.getElementById('reviewResultCard').classList.add('hidden');
        }

        // 更新复习进度
        function updateReviewProgress() {
            const progressText = `${appState.currentReviewWordIndex + 1}/${appState.reviewWords.length}`;
            document.getElementById('reviewProgress').textContent = progressText;
        }

        // 检查复习答案
        function checkReviewAnswer() {
            const input = document.getElementById('reviewAnswerInput').value.trim();
            const currentWord = appState.reviewWords[appState.currentReviewWordIndex];
            
            if (!input) {
                showModal('提示', '请输入答案', 'info');
                return;
            }

            // 处理多种正确拼写
            const correctAnswers = currentWord.english.split(',').map(ans => normalizeAnswer(ans));
            const userAnswer = normalizeAnswer(input);
            
            // 检查是否正确
            const isCorrect = correctAnswers.some(ans => ans === userAnswer);
            
            // 显示结果卡片，隐藏单词卡片
            document.getElementById('reviewCard').classList.add('hidden');
            document.getElementById('reviewResultCard').classList.remove('hidden');
            
            if (isCorrect) {
                // 正确
                document.getElementById('reviewCorrectResult').classList.remove('hidden');
                document.getElementById('reviewWrongResult').classList.add('hidden');
                document.getElementById('reviewCorrectWord').textContent = currentWord.english;
                
                // 更新单词统计
                currentWord.correct++;
                
                // 从错题中移除
                const wrongIndex = appState.wrongWords.findIndex(w => w.english === currentWord.english);
                if (wrongIndex !== -1) {
                    appState.wrongWords.splice(wrongIndex, 1);
                }
                
                // 添加到历史记录
                appState.history.unshift({
                    english: currentWord.english,
                    chinese: currentWord.chinese,
                    result: '正确(复习)',
                    date: new Date().toLocaleString()
                });
                
            } else {
                // 错误
                document.getElementById('reviewCorrectResult').classList.add('hidden');
                document.getElementById('reviewWrongResult').classList.remove('hidden');
                document.getElementById('reviewWrongWord').textContent = currentWord.english;
                
                // 分析错误原因
                const errorReason = getErrorReason(userAnswer, correctAnswers[0]);
                document.getElementById('reviewErrorReason').textContent = errorReason;
                
                // 更新单词统计
                currentWord.wrong++;
                
                // 添加到历史记录
                appState.history.unshift({
                    english: currentWord.english,
                    chinese: currentWord.chinese,
                    result: '错误(复习)',
                    date: new Date().toLocaleString()
                });
            }
            
            // 保存数据
            saveToLocalStorage();
            renderWrongWordsList();
        }

        // 下一个复习单词
        function nextReviewWord() {
            appState.currentReviewWordIndex++;
            updateReviewProgress();
            renderCurrentReviewWord();
        }

        // 完成复习会话
        function finishReviewSession() {
            // 找出仍然错误的单词
            const stillWrong = appState.reviewWords.filter(word => {
                // 检查这个单词是否还在错题列表中
                return appState.wrongWords.some(w => w.english === word.english);
            });
            
            // 显示完成界面
            document.getElementById('reviewContent').classList.add('hidden');
            document.getElementById('reviewComplete').classList.remove('hidden');
            
            if (stillWrong.length > 0) {
                // 还有错误单词
                document.getElementById('reviewCompleteMessage').textContent = `你完成了本轮复习，仍有${stillWrong.length}个单词需要加强`;
                document.getElementById('reviewAgainSection').classList.remove('hidden');
                // 保存仍错误的单词，供再次复习
                appState.reviewWords = stillWrong;
            } else {
                // 全部正确
                document.getElementById('reviewCompleteMessage').textContent = '恭喜你！所有错题都已掌握';
                document.getElementById('reviewAgainSection').classList.add('hidden');
            }
        }

        // 继续复习
        function reviewAgain() {
            appState.currentReviewWordIndex = 0;
            // 打乱顺序
            shuffleArray(appState.reviewWords);
            // 显示复习内容，隐藏完成界面
            document.getElementById('reviewContent').classList.remove('hidden');
            document.getElementById('reviewComplete').classList.add('hidden');
            renderCurrentReviewWord();
            updateReviewProgress();
        }

        // 结束复习
        function finishReview() {
            showSection('dashboard');
            updateDashboard();
        }

        // 显示提示
        function showHint() {
            const currentWord = appState.sessionWords[appState.currentWordIndex];
            const firstEnglish = currentWord.english.split(',')[0]; // 取第一个拼写
            let hint = '';
            
            if (appState.settings.showFirstLetter) {
                hint += `首字母: ${firstEnglish[0].toUpperCase()} `;
            }
            
            if (appState.settings.showWordLength) {
                hint += `长度: ${firstEnglish.length}个字母`;
            }
            
            showModal('提示', hint, 'info');
        }

        // 显示复习提示
        function showReviewHint() {
            const currentWord = appState.reviewWords[appState.currentReviewWordIndex];
            const firstEnglish = currentWord.english.split(',')[0]; // 取第一个拼写
            let hint = '';
            
            if (appState.settings.showFirstLetter) {
                hint += `首字母: ${firstEnglish[0].toUpperCase()} `;
            }
            
            if (appState.settings.showWordLength) {
                hint += `长度: ${firstEnglish.length}个字母`;
            }
            
            showModal('提示', hint, 'info');
        }

        // 更新仪表盘
        function updateDashboard() {
            // 更新统计数据
            const totalWords = appState.words.length;
            const learnedCount = appState.learnedWords.length;
            const learnedPercentage = totalWords > 0 ? (learnedCount / totalWords) * 100 : 0;
            
            let totalCorrect = 0;
            let totalAttempts = 0;
            appState.words.forEach(word => {
                totalCorrect += word.correct;
                totalAttempts += word.correct + word.wrong;
            });
            const correctRate = totalAttempts > 0 ? (totalCorrect / totalAttempts) * 100 : 0;
            
            const todayCount = appState.todayLearned;
            const todayPercentage = appState.dailyGoal > 0 ? (todayCount / appState.dailyGoal) * 100 : 0;
            
            const wrongCount = appState.wrongWords.length;
            const wrongPercentage = totalWords > 0 ? (wrongCount / totalWords) * 100 : 0;
            
            // 更新DOM
            document.getElementById('learnedCount').textContent = learnedCount;
            document.getElementById('learnedProgress').style.width = `${learnedPercentage}%`;
            
            document.getElementById('correctRate').textContent = `${Math.round(correctRate)}%`;
            document.getElementById('correctProgress').style.width = `${correctRate}%`;
            
            document.getElementById('todayCount').textContent = todayCount;
            document.getElementById('todayProgress').style.width = `${todayPercentage}%`;
            
            document.getElementById('wrongCount').textContent = wrongCount;
            document.getElementById('wrongProgress').style.width = `${wrongPercentage}%`;
            
            // 更新历史记录表格
            updateHistoryTable();
            
            // 更新图表
            updateProgressChart();
            updateMasteryChart();
        }

        // 更新历史记录表格
        function updateHistoryTable() {
            const historyTable = document.getElementById('historyTable');
            
            if (appState.history.length === 0) {
                historyTable.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">暂无学习记录</td>
                    </tr>
                `;
                return;
            }
            
            // 只显示最近20条记录
            const recentHistory = appState.history.slice(0, 20);
            
            let html = '';
            recentHistory.forEach(item => {
                const resultClass = item.result.includes('正确') ? 'text-secondary' : 'text-danger';
                html += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${item.english}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${item.chinese}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="${resultClass} font-medium">${item.result}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.date}</td>
                    </tr>
                `;
            });
            
            historyTable.innerHTML = html;
        }

        // 更新进度图表
        function updateProgressChart() {
            // 按日期统计学习数量
            const dailyStats = {};
            
            // 获取过去7天的日期
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString();
                dailyStats[dateStr] = 0;
            }
            
            // 统计每天的学习数量
            appState.history.forEach(item => {
                const date = new Date(item.date);
                const dateStr = date.toLocaleDateString();
                if (dailyStats.hasOwnProperty(dateStr)) {
                    dailyStats[dateStr]++;
                }
            });
            
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            // 如果图表已存在，销毁它
            if (window.progressChartInstance) {
                window.progressChartInstance.destroy();
            }
            
            // 创建新图表
            window.progressChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(dailyStats),
                    datasets: [{
                        label: '学习数量',
                        data: Object.values(dailyStats),
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // 更新掌握情况图表
        function updateMasteryChart() {
            // 计算掌握程度
            const masteryLevels = {
                '未学习': 0,
                '需复习': 0,
                '已掌握': 0
            };
            
            appState.words.forEach(word => {
                if (!appState.learnedWords.includes(word.english)) {
                    masteryLevels['未学习']++;
                } else if (appState.wrongWords.some(w => w.english === word.english)) {
                    masteryLevels['需复习']++;
                } else {
                    masteryLevels['已掌握']++;
                }
            });
            
            const ctx = document.getElementById('masteryChart').getContext('2d');
            
            // 如果图表已存在，销毁它
            if (window.masteryChartInstance) {
                window.masteryChartInstance.destroy();
            }
            
            // 创建新图表
            window.masteryChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(masteryLevels),
                    datasets: [{
                        data: Object.values(masteryLevels),
                        backgroundColor: [
                            'rgba(156, 163, 175, 0.7)', // 未学习 - 灰色
                            'rgba(245, 158, 11, 0.7)',  // 需复习 - 橙色
                            'rgba(16, 185, 129, 0.7)'   // 已掌握 - 绿色
                        ],
                        borderColor: [
                            'rgba(156, 163, 175, 1)',
                            'rgba(245, 158, 11, 1)',
                            'rgba(16, 185, 129, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 导出历史记录
        function exportHistory() {
            if (appState.history.length === 0) {
                showModal('提示', '暂无学习记录可导出', 'info');
                return;
            }
            
            // 准备导出数据
            const exportData = appState.history.map(item => {
                return {
                    '单词': item.english,
                    '中文': item.chinese,
                    '结果': item.result,
                    '日期': item.date
                };
            });
            
            // 创建工作簿和工作表
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '学习记录');
            
            // 导出文件
            XLSX.writeFile(wb, `单词学习记录_${new Date().toLocaleDateString()}.xlsx`);
        }

        // 导出错题
        function exportWrongWords() {
            if (appState.wrongWords.length === 0) {
                showModal('提示', '暂无错题可导出', 'info');
                return;
            }
            
            // 准备导出数据
            const exportData = appState.wrongWords.map(item => {
                return {
                    '单词': item.english,
                    '中文': item.chinese,
                    '正确次数': item.correct,
                    '错误次数': item.wrong
                };
            });
            
            // 创建工作簿和工作表
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '错题记录');
            
            // 导出文件
            XLSX.writeFile(wb, `单词错题记录_${new Date().toLocaleDateString()}.xlsx`);
        }

        // 导出单词
        function exportWords(format) {
            if (appState.words.length === 0) {
                showModal('提示', '暂无单词可导出', 'info');
                return;
            }
            
            if (format === 'txt') {
                // 导出为TXT
                let content = '';
                appState.words.forEach(word => {
                    content += `${word.english},${word.chinese}\n`;
                });
                
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `单词库_${new Date().toLocaleDateString()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                // 导出为Excel
                const exportData = appState.words.map(item => {
                    return {
                        '单词': item.english,
                        '中文': item.chinese,
                        '正确次数': item.correct,
                        '错误次数': item.wrong
                    };
                });
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '单词库');
                XLSX.writeFile(wb, `单词库_${new Date().toLocaleDateString()}.xlsx`);
            }
        }

        // 加载设置
        function loadSettings() {
            document.getElementById('showFirstLetter').checked = appState.settings.showFirstLetter;
            document.getElementById('showWordLength').checked = appState.settings.showWordLength;
        }

        // 保存设置
        function saveSettings() {
            appState.settings.showFirstLetter = document.getElementById('showFirstLetter').checked;
            appState.settings.showWordLength = document.getElementById('showWordLength').checked;
            
            saveToLocalStorage();
            showModal('设置已保存', '您的设置已成功保存', 'success');
        }

        // 添加新单词
        function addNewWord() {
            const english = document.getElementById('newWord').value.trim();
            const chinese = document.getElementById('newTranslation').value.trim();
            
            if (!english || !chinese) {
                showModal('提示', '请输入单词和翻译', 'info');
                return;
            }
            
            // 检查是否已存在
            const exists = appState.words.some(word => 
                word.english.toLowerCase() === english.toLowerCase() && 
                word.chinese === chinese
            );
            
            if (exists) {
                showModal('提示', '该单词已存在', 'info');
                return;
            }
            
            // 添加新单词
            appState.words.push({
                english: english,
                chinese: chinese,
                correct: 0,
                wrong: 0
            });
            
            // 保存并刷新表格
            saveToLocalStorage();
            renderWordsTable();
            
            // 清空输入框
            document.getElementById('newWord').value = '';
            document.getElementById('newTranslation').value = '';
            
            showModal('添加成功', '单词已成功添加到单词库', 'success');
        }

        // 编辑单词
        function editWord(index) {
            const word = appState.words[index];
            document.getElementById('editWordIndex').value = index;
            document.getElementById('editEnglish').value = word.english;
            document.getElementById('editChinese').value = word.chinese;
            document.getElementById('editWordModal').classList.remove('hidden');
        }

        // 保存编辑的单词
        function saveEditedWord() {
            const index = parseInt(document.getElementById('editWordIndex').value);
            const english = document.getElementById('editEnglish').value.trim();
            const chinese = document.getElementById('editChinese').value.trim();
            
            if (!english || !chinese) {
                showModal('提示', '请输入单词和翻译', 'info');
                return;
            }
            
            // 更新单词
            appState.words[index].english = english;
            appState.words[index].chinese = chinese;
            
            // 保存并刷新表格
            saveToLocalStorage();
            renderWordsTable();
            renderWrongWordsList();
            
            // 关闭模态框
            document.getElementById('editWordModal').classList.add('hidden');
            
            showModal('修改成功', '单词已成功修改', 'success');
        }

        // 删除单词
        function deleteWord(index) {
            const word = appState.words[index];
            
            // 从已学单词中移除
            const learnedIndex = appState.learnedWords.indexOf(word.english);
            if (learnedIndex !== -1) {
                appState.learnedWords.splice(learnedIndex, 1);
            }
            
            // 从错题中移除
            const wrongIndex = appState.wrongWords.findIndex(w => w.english === word.english);
            if (wrongIndex !== -1) {
                appState.wrongWords.splice(wrongIndex, 1);
            }
            
            // 删除单词
            appState.words.splice(index, 1);
            
            // 保存并刷新表格
            saveToLocalStorage();
            renderWordsTable();
            renderWrongWordsList();
            
            showModal('删除成功', '单词已成功删除', 'success');
        }

        // 渲染单词表格
        function renderWordsTable() {
            const wordsTable = document.getElementById('wordsTable');
            
            if (appState.words.length === 0) {
                wordsTable.innerHTML = `
                    <tr>
                        <td colspan="3" class="px-6 py-4 text-center text-gray-500">暂无单词，请添加新单词</td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            appState.words.forEach((word, index) => {
                html += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${word.english}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${word.chinese}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="editWord(${index})" class="text-primary hover:text-primary/80 mr-3">
                                <i class="fa fa-pencil"></i> 修改
                            </button>
                            <button onclick="deleteWord(${index})" class="text-danger hover:text-danger/80">
                                <i class="fa fa-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            wordsTable.innerHTML = html;
        }

        // 渲染错题列表
        function renderWrongWordsList() {
            const wrongWordsList = document.getElementById('wrongWordsList');
            
            if (appState.wrongWords.length === 0) {
                wrongWordsList.innerHTML = `
                    <div class="col-span-full text-center text-gray-500">暂无错题</div>
                `;
                return;
            }
            
            let html = '';
            appState.wrongWords.forEach(word => {
                html += `
                    <div class="bg-red-50 p-3 rounded-lg border border-red-100 flex justify-between items-center">
                        <div>
                            <div class="font-bold text-gray-800">${word.english}</div>
                            <div class="text-sm text-gray-600">${word.chinese}</div>
                        </div>
                        <div class="text-xs text-gray-500">
                            错误: ${word.wrong}次
                        </div>
                    </div>
                `;
            });
            
            wrongWordsList.innerHTML = html;
        }

        // 导入单词
        function importWords() {
            const fileInput = document.getElementById('wordFile');
            if (!fileInput.files || fileInput.files.length === 0) {
                showModal('提示', '请选择要导入的文件', 'info');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let newWords = [];
                    const fileName = file.name.toLowerCase();
                    
                    if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        // 处理Excel文件
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        jsonData.forEach(item => {
                            // 尝试不同的列名可能性
                            let english, chinese;
                            
                            if (item.单词 && item.中文) {
                                english = item.单词.toString().trim();
                                chinese = item.中文.toString().trim();
                            } else if (item.English && item.Chinese) {
                                english = item.English.toString().trim();
                                chinese = item.Chinese.toString().trim();
                            } else if (item[0] && item[1]) {
                                english = item[0].toString().trim();
                                chinese = item[1].toString().trim();
                            } else {
                                // 尝试获取第一个和第二个属性
                                const keys = Object.keys(item);
                                if (keys.length >= 2) {
                                    english = item[keys[0]].toString().trim();
                                    chinese = item[keys[1]].toString().trim();
                                } else {
                                    return; // 跳过格式不正确的行
                                }
                            }
                            
                            if (english && chinese) {
                                newWords.push({ english, chinese });
                            }
                        });
                    } else {
                        // 处理TXT/CSV文件
                        const content = e.target.result;
                        const lines = content.split('\n');
                        
                        lines.forEach(line => {
                            const trimmedLine = line.trim();
                            if (trimmedLine) {
                                const parts = trimmedLine.split(',');
                                if (parts.length >= 2) {
                                    const english = parts[0].trim();
                                    const chinese = parts.slice(1).join(',').trim(); // 允许翻译中包含逗号
                                    if (english && chinese) {
                                        newWords.push({ english, chinese });
                                    }
                                }
                            }
                        });
                    }
                    
                    // 去重并添加到单词库
                    let addedCount = 0;
                    newWords.forEach(newWord => {
                        const exists = appState.words.some(word => 
                            word.english.toLowerCase() === newWord.english.toLowerCase() && 
                            word.chinese === newWord.chinese
                        );
                        
                        if (!exists) {
                            appState.words.push({
                                ...newWord,
                                correct: 0,
                                wrong: 0
                            });
                            addedCount++;
                        }
                    });
                    
                    // 保存并刷新表格
                    saveToLocalStorage();
                    renderWordsTable();
                    
                    // 重置文件输入
                    fileInput.value = '';
                    document.getElementById('fileName').textContent = '未选择文件';
                    
                    showModal('导入成功', `成功导入 ${addedCount} 个新单词，${newWords.length - addedCount} 个单词已存在`, 'success');
                } catch (error) {
                    console.error('导入错误:', error);
                    showModal('导入失败', '文件格式不正确或内容有误', 'error');
                }
            };
            
            if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }

        // 删除所有单词
        function deleteAllWords() {
            if (appState.words.length === 0) {
                showModal('提示', '单词库已为空', 'info');
                return;
            }
            
            if (confirm('确定要删除所有单词吗？此操作不可恢复！')) {
                appState.words = [];
                appState.learnedWords = [];
                appState.wrongWords = [];
                
                saveToLocalStorage();
                renderWordsTable();
                renderWrongWordsList();
                updateDashboard();
                
                showModal('删除成功', '所有单词已删除', 'success');
            }
        }

        // 重置学习进度
        function resetProgress() {
            if (confirm('确定要重置所有学习进度吗？单词库不会被删除')) {
                appState.learnedWords = [];
                appState.wrongWords = [];
                appState.history = [];
                appState.todayLearned = 0;
                
                // 重置每个单词的统计
                appState.words.forEach(word => {
                    word.correct = 0;
                    word.wrong = 0;
                });
                
                saveToLocalStorage();
                renderWrongWordsList();
                updateDashboard();
                
                showModal('重置成功', '学习进度已重置', 'success');
            }
        }

        // 删除所有数据
        function deleteAllData() {
            if (confirm('确定要删除所有数据吗？包括单词库和学习记录，此操作不可恢复！')) {
                appState.words = [];
                appState.learnedWords = [];
                appState.wrongWords = [];
                appState.history = [];
                appState.todayLearned = 0;
                
                saveToLocalStorage();
                renderWordsTable();
                renderWrongWordsList();
                updateDashboard();
                
                showModal('删除成功', '所有数据已删除', 'success');
            }
        }

        // 显示模态框
        function showModal(title, message, type = 'info') {
            modal.title.textContent = title;
            modal.message.textContent = message;
            
            // 设置图标
            modal.icon.className = '';
            if (type === 'success') {
                modal.icon.className = 'inline-block bg-secondary p-4 rounded-full mb-2';
                modal.icon.innerHTML = '<i class="fa fa-check-circle text-3xl text-white"></i>';
            } else if (type === 'error') {
                modal.icon.className = 'inline-block bg-danger p-4 rounded-full mb-2';
                modal.icon.innerHTML = '<i class="fa fa-times-circle text-3xl text-white"></i>';
            } else {
                modal.icon.className = 'inline-block bg-primary p-4 rounded-full mb-2';
                modal.icon.innerHTML = '<i class="fa fa-info-circle text-3xl text-white"></i>';
            }
            
            modal.element.classList.remove('hidden');
        }

        // 保存数据到本地存储
        function saveToLocalStorage() {
            try {
                localStorage.setItem('wordAppState', JSON.stringify(appState));
                // 使用专门的函数保存开始时间（包含加密）
                saveStartTime();
                localStorage.setItem('membershipVerified', membershipVerified.toString());
            } catch (error) {
                console.error('保存数据失败:', error);
                showModal('保存失败', '数据保存失败，请检查浏览器存储设置', 'error');
            }
        }

        // 从本地存储加载数据
        function loadFromLocalStorage() {
            try {
                const savedState = localStorage.getItem('wordAppState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    // 合并保存的状态（防止新增属性丢失）
                    Object.assign(appState, parsedState);
                }
                
                const savedStartTime = localStorage.getItem('appStartTime');
                if (savedStartTime) {
                    // 使用专门的时间初始化函数
                    initAppStartTime();
                }
            } catch (error) {
                console.error('加载数据失败:', error);
                showModal('加载失败', '数据加载失败，将使用默认设置', 'error');
            }
        }

        // 打乱数组顺序
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // 暴露给全局，用于HTML中的onclick调用
        window.editWord = editWord;
        window.deleteWord = deleteWord;

        // 初始化应用
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>